// ==UserScript==
// @name         TwitchAdSolutions (vaft)
// @namespace    https://github.com/pixeltris/TwitchAdSolutions
// @version      24.0.0
// @updateURL https://raw.githubusercontent.com/AzimsTech/Userscripts/release/release/Avaft.meta.js
// @downloadURL https://raw.githubusercontent.com/AzimsTech/Userscripts/release/release/Avaft.user.js
// @author       https://github.com/cleanlock/VideoAdBlockForTwitch#credits
// @match        *://*.twitch.tv/*
// @run-at       document-start
// @inject-into  page
// @grant        GM.xmlHttpRequest
// @connect      gql.twitch.tv
// ==/UserScript==
(function(){"use strict";var A=9;if(typeof unsafeWindow>"u"&&(unsafeWindow=window),typeof unsafeWindow.twitchAdSolutionsVersion<"u"&&unsafeWindow.twitchAdSolutionsVersion>=A){console.log("skipping vaft as there's another script active. ourVersion:"+A+" activeVersion:"+unsafeWindow.twitchAdSolutionsVersion),unsafeWindow.twitchAdSolutionsVersion=A;return}unsafeWindow.twitchAdSolutionsVersion=A;function O(a){a.AdSignifier="stitched",a.ClientID="kimne78kx3ncx6brgo4mv6wki5h1ko",a.ClientVersion="null",a.ClientSession="null",a.PlayerType2="embed",a.PlayerType3="site",a.PlayerType4="autoplay",a.CurrentChannelName=null,a.UsherParams=null,a.WasShowingAd=!1,a.GQLDeviceID=null,a.IsSquadStream=!1,a.StreamInfos=[],a.StreamInfosByUrl=[],a.MainUrlByUrl=[],a.EncodingCacheTimeout=6e4,a.ClientIntegrityHeader=null,a.AuthorizationHeader=null}var U=[],w=null,k=null,D=null,_=["twitch","isVariantA"],H=[],P=["isVariantA","besuper/","${patch_url}"];function q(a){for(var e=null,t=null,n=a;n;){var i=n.toString();_.some(d=>i.includes(d))&&!H.some(d=>i.includes(d))?t!==null&&Object.setPrototypeOf(t,Object.getPrototypeOf(n)):(e===null&&(e=n),t=n),n=Object.getPrototypeOf(n)}return e}function $(a){for(var e=[],t=a;t;){var n=t.toString();P.some(i=>n.includes(i))&&e.push(t),t=Object.getPrototypeOf(t)}return e}function B(a,e){for(var t=a,n=0;n<e.length;n++)Object.setPrototypeOf(e[n],t),t=e[n];return t}function j(a){var e=a.toString();return!_.some(t=>e.includes(t))||H.some(t=>e.includes(t))||P.some(t=>e.includes(t))}function G(){var a=$(unsafeWindow.Worker),e=class extends q(unsafeWindow.Worker){constructor(i,d){var s=!1;try{s=new URL(i).origin.endsWith(".twitch.tv")}catch{}if(!s){super(i,d);return}var u=`
                    const pendingFetchRequests = new Map();
                    ${M.toString()}
                    ${T.toString()}
                    ${z.toString()}
                    ${I.toString()}
                    ${X.toString()}
                    ${O.toString()}
                    ${V.toString()}
                    ${C.toString()}
                    ${R.toString()}
                    ${J.toString()}
                    ${S.toString()}
                    ${Q.toString()}
                    var workerString = getWasmWorkerJs('${i.replaceAll("'","%27")}');
                    declareOptions(self);
                    self.addEventListener('message', function(e) {
                        if (e.data.key == 'UpdateIsSquadStream') {
                            IsSquadStream = e.data.value;
                        } else if (e.data.key == 'UpdateClientVersion') {
                            ClientVersion = e.data.value;
                        } else if (e.data.key == 'UpdateClientSession') {
                            ClientSession = e.data.value;
                        } else if (e.data.key == 'UpdateClientId') {
                            ClientID = e.data.value;
                        } else if (e.data.key == 'UpdateDeviceId') {
                            GQLDeviceID = e.data.value;
                        } else if (e.data.key == 'UpdateClientIntegrityHeader') {
                            ClientIntegrityHeader = e.data.value;
                        } else if (e.data.key == 'UpdateAuthorizationHeader') {
                            AuthorizationHeader = e.data.value;
                        } else if (e.data.key == 'FetchResponse') {
                            const responseData = e.data.value;
                            if (pendingFetchRequests.has(responseData.id)) {
                                const { resolve, reject } = pendingFetchRequests.get(responseData.id);
                                pendingFetchRequests.delete(responseData.id);
                                if (responseData.error) {
                                    reject(new Error(responseData.error));
                                } else {
                                    // Create a Response object from the response data
                                    const response = new Response(responseData.body, {
                                        status: responseData.status,
                                        statusText: responseData.statusText,
                                        headers: responseData.headers
                                    });
                                    resolve(response);
                                }
                            }
                        }
                    });
                    hookWorkerFetch();
                    eval(workerString);
                `;super(URL.createObjectURL(new Blob([u])),d),U.push(this),this.addEventListener("message",r=>{if(r.data.key=="ShowAdBlockBanner")w==null&&(w=f()),w.P.textContent="Blocking ads",w.style.display="block";else if(r.data.key=="HideAdBlockBanner")w==null&&(w=f()),w.style.display="none";else if(r.data.key=="PauseResumePlayer")b(!0,!1,!1,!1,!1);else if(r.data.key=="ForceChangeQuality")try{return;var l,o;if((!o.includes("360")||r.data.value!=null)&&!k.includes("360")){var p;if(p==null){var g=document.querySelector('button[data-a-target="player-settings-button"]');if(g){g.click();var c=document.querySelector('button[data-a-target="player-settings-menu-item-quality"]');c&&c.click();var v=document.querySelectorAll('input[data-a-target="tw-radio"');if(v){var h=v.length-2;r.data.value!=null&&(r.data.value.includes("original")&&(r.data.value=k,D&&(r.data.value="auto")),r.data.value.includes("160p")&&(h=5),r.data.value.includes("360p")&&(h=4),r.data.value.includes("480p")&&(h=3),r.data.value.includes("720p")&&(h=2),r.data.value.includes("822p")&&(h=2),r.data.value.includes("864p")&&(h=2),r.data.value.includes("900p")&&(h=2),r.data.value.includes("936p")&&(h=2),r.data.value.includes("960p")&&(h=2),r.data.value.includes("1080p")&&(h=2),r.data.value.includes("source")&&(h=1),r.data.value.includes("auto")&&(h=0));var y=unsafeWindow.localStorage.getItem("video-quality");v[h].click(),g.click(),unsafeWindow.localStorage.setItem("video-quality",y),r.data.value!=null&&(k=null,D=null,b(!1,!1,!1,!0,!0))}}}}}catch{k=null,D=null}}),this.addEventListener("message",async r=>{if(r.data.key=="FetchRequest"){const l=r.data.value,o=await Y(l);this.postMessage({key:"FetchResponse",value:o})}});function f(){var r=document.querySelector(".video-player"),l=null;return r!=null&&(l=r.querySelector(".adblock-overlay"),l==null&&(l=document.createElement("div"),l.className="adblock-overlay",l.innerHTML='<div class="player-adblock-notice" style="color: white; background-color: rgba(0, 0, 0, 0.8); position: absolute; top: 0px; left: 0px; padding: 5px;"><p></p></div>',l.style.display="none",l.P=l.querySelector("p"),r.appendChild(l))),l}}},t=B(e,a);Object.defineProperty(unsafeWindow,"Worker",{get:function(){return t},set:function(n){j(n)?t=n:console.log("Attempt to set twitch worker denied")}})}function Q(a){var e=new XMLHttpRequest;return e.open("GET",a,!1),e.overrideMimeType("text/javascript"),e.send(),e.responseText}function X(){console.log("hookWorkerFetch (vaft)");var a=fetch;fetch=async function(e,t){if(typeof e=="string"){if(e.endsWith("m3u8"))return new Promise(function(d,s){var u=async function(r){if(r.status===200){var l=await r.text(),o=null;o=await I(e,l,a,PlayerType2),o.includes(AdSignifier)&&(o=await I(e,l,a,PlayerType3)),o.includes(AdSignifier)&&(o=await I(e,l,a,PlayerType4)),d(new Response(o))}else d(r)},f=function(){return a(e,t).then(function(r){u(r)}).catch(function(r){s(r)})};f()});if(e.includes("/api/channel/hls/")){var n=new URL(e).pathname.match(/([^\/]+)(?=\.\w+$)/)[0];UsherParams=new URL(e).search,CurrentChannelName=n;var i=e.includes("picture-by-picture");return i&&(e=""),new Promise(function(d,s){var u=async function(r){if(r.status==200){encodingsM3u8=await r.text();var l=StreamInfos[n];l==null&&(StreamInfos[n]=l={}),l.ChannelName=n,l.RequestedAds=new Set,l.Urls=[],l.EncodingsM3U8Cache=[],l.EncodingsM3U8=encodingsM3u8;for(var o=encodingsM3u8.replace("\r","").split(`
`),p=0;p<o.length;p++)if(!o[p].startsWith("#")&&o[p].includes(".m3u8")){if(l.Urls[o[p]]=-1,p>0&&o[p-1].startsWith("#EXT-X-STREAM-INF")){var g=S(o[p-1]),c=g.RESOLUTION,v=g["FRAME-RATE"];c&&(l.Urls[o[p]]={Resolution:c,FrameRate:v})}StreamInfosByUrl[o[p]]=l,MainUrlByUrl[o[p]]=e}d(new Response(encodingsM3u8))}else d(r)},f=function(){return a(e,t).then(function(r){u(r)}).catch(function(r){s(r)})};f()})}}return a.apply(this,arguments)}}function M(a,e,t){var n=0;t&&t.endsWith("p")&&(n=t.substr(0,t.length-1)|0);for(var i=0,d=0,s=a.replace("\r","").split(`
`),u=null,f=null,r=null,l=!1,o=0;o<s.length;o++)if(!s[o].startsWith("#")&&s[o].includes(".m3u8")&&o>0&&s[o-1].startsWith("#EXT-X-STREAM-INF")){var p=S(s[o-1]),g=p.RESOLUTION,c=p["FRAME-RATE"];if(g){if(n){var v=g.toLowerCase().split("x")[1];if(v==n){if(i=v,d=c,r=s[o],c<40)return r}else if(v<n)return r||s[o]}else if((!e||g==e.Resolution)&&(!r||!l&&c==e.FrameRate)&&(r=s[o],l=c==e.FrameRate,l))return r}u==null&&(u=s[o]),f=s[o]}return n?f:r||u}async function T(a,e,t,n,i,d){var s=null;(a.EncodingsM3U8Cache[i].Resolution!=e.Resolution||a.EncodingsM3U8Cache[i].RequestTime<Date.now()-EncodingCacheTimeout)&&console.log(`Blocking ads (type:${i}, resolution:${e.Resolution}, frameRate:${e.FrameRate}, qualityOverride:${s})`),a.EncodingsM3U8Cache[i].RequestTime=Date.now(),a.EncodingsM3U8Cache[i].Value=t,a.EncodingsM3U8Cache[i].Resolution=e.Resolution;var u=M(t,e,s),f=await d(u);if(f.status==200){var r=await f.text();return WasShowingAd=!0,postMessage({key:"ShowAdBlockBanner"}),postMessage({key:"ForceChangeQuality"}),(!r||r.includes(AdSignifier))&&(a.EncodingsM3U8Cache[i].Value=null),r}else return a.EncodingsM3U8Cache[i].Value=null,n}function z(a,e){e||(e=["token","sig"]);for(var t=new URL("https://localhost/"+a),n=0;n<e.length;n++)t.searchParams.delete(e[n]);return t.pathname.substring(1)+t.search}async function I(a,e,t,n){var i=StreamInfosByUrl[a];if(IsSquadStream==!0||!e||!e.includes(".ts")&&!e.includes(".mp4"))return e;var d=e.includes(AdSignifier);if(d){var s=e.includes('"MIDROLL"')||e.includes('"midroll"');if(!s&&n===PlayerType2)for(var u=e.replace("\r","").split(`
`),f=0;f<u.length;f++){var r=u[f];if(r.startsWith("#EXTINF")&&u.length>f+1&&!r.includes(",live")&&!i.RequestedAds.has(u[f+1])){i.RequestedAds.add(u[f+1]),fetch(u[f+1]).then(y=>{y.blob()});break}}var l=null;if(i&&i.Urls){for(const[y,N]of Object.entries(i.Urls))if(y==a){l=N;break}}var o=i.EncodingsM3U8Cache[n];if(o){if(o.Value&&o.RequestTime>=Date.now()-EncodingCacheTimeout)try{var p=T(i,l,o.Value,null,n,t);if(p)return p}catch{o.Value=null}}else i.EncodingsM3U8Cache[n]={RequestTime:Date.now(),Value:null,Resolution:null};var g=await V(CurrentChannelName,n);if(g.status===200){var c=await g.json();try{var v=new URL("https://usher.ttvnw.net/api/channel/hls/"+CurrentChannelName+".m3u8"+UsherParams);v.searchParams.set("sig",c.data.streamPlaybackAccessToken.signature),v.searchParams.set("token",c.data.streamPlaybackAccessToken.value);var h=await t(v.href);return h.status===200?T(i,l,await h.text(),e,n,t):e}catch{}return e}else return e}else return WasShowingAd&&(console.log("Finished blocking ads"),WasShowingAd=!1,postMessage({key:"ForceChangeQuality",value:"original"}),postMessage({key:"PauseResumePlayer"}),postMessage({key:"HideAdBlockBanner"})),e;return e}function S(a){return Object.fromEntries(a.split(/(?:^|,)((?:[^=]*)=(?:"[^"]*"|[^,]*))/).filter(Boolean).map(e=>{const t=e.indexOf("="),n=e.substring(0,t),i=e.substring(t+1),d=Number(i);return[n,Number.isNaN(d)?i.startsWith('"')?JSON.parse(i):i:d]}))}async function J(a){var e=a.match(/#EXT-X-DATERANGE:(ID="stitched-ad-[^\n]+)\n/);if(e.length>1){const l=e[1],o=S(l);var t=parseInt(o["X-TV-TWITCH-AD-POD-LENGTH"]?o["X-TV-TWITCH-AD-POD-LENGTH"]:"1"),n=parseInt(o["X-TV-TWITCH-AD-POD-POSITION"]?o["X-TV-TWITCH-AD-POD-POSITION"]:"0"),i=o["X-TV-TWITCH-AD-RADS-TOKEN"],d=o["X-TV-TWITCH-AD-LINE-ITEM-ID"],s=o["X-TV-TWITCH-AD-ORDER-ID"],u=o["X-TV-TWITCH-AD-CREATIVE-ID"],f=o["X-TV-TWITCH-AD-ADVERTISER-ID"],r=o["X-TV-TWITCH-AD-ROLL-TYPE"].toLowerCase();const p={stitched:!0,roll_type:r,player_mute:!0,player_volume:0,visible:!1};for(let g=0;g<t;g++){const c={...p,ad_id:f,ad_position:g,duration:0,creative_id:u,total_ads:t,order_id:s,line_item_id:d};await C(R("video_ad_impression",i,c));for(let v=0;v<4;v++)await C(R("video_ad_quartile_complete",i,{...c,quartile:v+1}));await C(R("video_ad_pod_complete",i,p))}}}function R(a,e,t){return[{operationName:"ClientSideAdEventHandling_RecordAdEvent",variables:{input:{eventName:a,eventPayload:JSON.stringify(t),radToken:e}},extensions:{persistedQuery:{version:1,sha256Hash:"7e6c69e6eb59f8ccb97ab73686f3d8b7d85a72a0298745ccd8bfc68e4054ca5b"}}}]}function V(a,e){var t=null,n='query PlaybackAccessToken_Template($login: String!, $isLive: Boolean!, $vodID: ID!, $isVod: Boolean!, $playerType: String!) {  streamPlaybackAccessToken(channelName: $login, params: {platform: "ios", playerBackend: "mediaplayer", playerType: $playerType}) @include(if: $isLive) {    value    signature    __typename  }  videoPlaybackAccessToken(id: $vodID, params: {platform: "ios", playerBackend: "mediaplayer", playerType: $playerType}) @include(if: $isVod) {    value    signature    __typename  }}';return t={operationName:"PlaybackAccessToken_Template",query:n,variables:{isLive:!0,login:a,isVod:!1,vodID:"",playerType:e}},C(t)}function C(a){if(!GQLDeviceID)for(var e="abcdefghijklmnopqrstuvwxyz0123456789",t=e.length,n=0;n<32;n++)GQLDeviceID+=e.charAt(Math.floor(Math.random()*t));var i={"Client-ID":ClientID,"Client-Integrity":ClientIntegrityHeader,"Device-ID":GQLDeviceID,"X-Device-Id":GQLDeviceID,"Client-Version":ClientVersion,"Client-Session-Id":ClientSession,Authorization:AuthorizationHeader};return new Promise((d,s)=>{const u=Math.random().toString(36).substring(2,15),f={id:u,url:"https://gql.twitch.tv/gql",options:{method:"POST",body:JSON.stringify(a),headers:i}};pendingFetchRequests.set(u,{resolve:d,reject:s}),postMessage({key:"FetchRequest",value:f})})}function b(a,e,t,n,i){try{let p=function(c,v){if(c.stateNode&&v(c.stateNode))return c.stateNode;let h=c.child;for(;h;){const y=p(h,v);if(y)return y;h=h.sibling}return null},g=function(){var c=null,v=document.querySelector("#root");if(v&&v._reactRootContainer&&v._reactRootContainer._internalRoot&&v._reactRootContainer._internalRoot.current&&(c=v._reactRootContainer._internalRoot.current),c==null){var h=Object.keys(v).find(y=>y.startsWith("__reactContainer"));h!=null&&(c=v[h])}return c};var d=null,s=null,u=g();if(!u){console.log("Could not find react root");return}if(s=p(u,c=>c.setPlayerActive&&c.props&&c.props.mediaPlayerInstance),s=s&&s.props&&s.props.mediaPlayerInstance?s.props.mediaPlayerInstance:null,a){s.pause(),s.play();return}if(e){if(typeof s.getQuality()>"u")return;var f=JSON.stringify(s.getQuality());return f||void 0}if(n){if(typeof s.isAutoQualityMode()>"u")return!1;var r=s.isAutoQualityMode();return r?(s.setAutoQualityMode(!1),r):!1}if(i){s.setAutoQualityMode(!0);return}try{var l=document.URL,o=!0;(l.includes("videos/")||l.includes("clip/"))&&(o=!1),t&&o&&setTimeout(function(){(s.isLiveLowLatency()&&s.getLiveLatency()>5||s.getLiveLatency()>15)&&(s.pause(),s.play())},3e3)}catch{}}catch{}}unsafeWindow.reloadTwitchPlayer=b;var W=null;W=unsafeWindow.localStorage.getItem("local_copy_unique_id");function m(a,e){U.forEach(t=>{t.postMessage({key:a,value:e})})}function x(a){return new Promise((e,t)=>{GM.xmlHttpRequest({method:a.options.method,url:a.url,data:a.options.body,headers:a.options.headers,onload:n=>e(n),onerror:n=>t(n)})})}function K(a){const e=new Headers;return a.trim().split(/[\r\n]+/).forEach(n=>{const i=n.split(":"),d=i.shift(),s=i.join(":");e.append(d,s)}),e}var E=!1,L=!1;async function Y(a){try{if(E||!L){const t=await unsafeWindow.realFetch(a.url,a.options),n=await t.text(),i={id:a.id,status:t.status,statusText:t.statusText,headers:Object.fromEntries(t.headers.entries()),body:n};if(i.status===200){var e=JSON.parse(n);typeof e.errors<"u"?L=!0:E=!0}if(E||!L)return i}if(typeof GM<"u"&&typeof GM.xmlHttpRequest<"u"){a.options.headers["Sec-Ch-Ua"]='"Google Chrome";v="137", "Chromium";v="137", "Not/A)Brand";v="24"',a.options.headers.Referer="https://www.twitch.tv/",a.options.headers.Origin="https://www.twitch.tv/",a.options.headers.Host="gql.twitch.tv";const t=await x(a),n=t.responseText;return{id:a.id,status:t.status,statusText:t.statusText,headers:Object.fromEntries(K(t.responseHeaders).entries()),body:n}}throw{message:"Failed to resolve GQL request. Try the userscript version of the ad blocking solution"}}catch(t){return{id:a.id,error:t.message}}}function Z(){var a=unsafeWindow.fetch;unsafeWindow.realFetch=a,unsafeWindow.fetch=function(e,t,...n){if(typeof e=="string"&&(unsafeWindow.location.pathname.includes("/squad")?m("UpdateIsSquadStream",!0):m("UpdateIsSquadStream",!1),e.includes("/access_token")||e.includes("gql"))){var i=t.headers["X-Device-Id"];typeof i!="string"&&(i=t.headers["Device-ID"]),typeof i=="string"&&!i.includes("twitch-web-wall-mason")?GQLDeviceID=i:W&&(GQLDeviceID=W.replace('"',""),GQLDeviceID=GQLDeviceID.replace('"',"")),GQLDeviceID&&(typeof t.headers["X-Device-Id"]=="string"&&(t.headers["X-Device-Id"]=GQLDeviceID),typeof t.headers["Device-ID"]=="string"&&(t.headers["Device-ID"]=GQLDeviceID),m("UpdateDeviceId",GQLDeviceID));var d=t.headers["Client-Version"];d&&typeof d=="string"&&(ClientVersion=d),ClientVersion&&m("UpdateClientVersion",ClientVersion);var s=t.headers["Client-Session-Id"];if(s&&typeof s=="string"&&(ClientSession=s),ClientSession&&m("UpdateClientSession",ClientSession),e.includes("gql")&&t&&typeof t.body=="string"&&t.body.includes("PlaybackAccessToken")){var u=t.headers["Client-ID"];u&&typeof u=="string"?ClientID=u:(u=t.headers["Client-Id"],u&&typeof u=="string"&&(ClientID=u)),ClientID&&m("UpdateClientId",ClientID),ClientIntegrityHeader=t.headers["Client-Integrity"],ClientIntegrityHeader&&m("UpdateClientIntegrityHeader",ClientIntegrityHeader),AuthorizationHeader=t.headers.Authorization,AuthorizationHeader&&m("UpdateAuthorizationHeader",AuthorizationHeader)}e.includes("gql")&&t&&typeof t.body=="string"&&t.body.includes("PlaybackAccessToken")&&t.body.includes("picture-by-picture")&&(t.body="");var f=e.includes("picture-by-picture");f&&(e="")}return a.apply(this,arguments)}}function F(){try{Object.defineProperty(document,"visibilityState",{get(){return"visible"}})}catch{}let a=document.__lookupGetter__("hidden"),e=document.__lookupGetter__("webkitHidden");try{Object.defineProperty(document,"hidden",{get(){return!1}})}catch{}var t=d=>{d.preventDefault(),d.stopPropagation(),d.stopImmediatePropagation()};let n=!0;var i=d=>{if(typeof chrome<"u"){const s=document.getElementsByTagName("video");s.length>0&&(a.apply(document)===!0||e&&e.apply(document)===!0?n=!s[0].paused&&!s[0].ended:n&&!s[0].ended&&s[0].play())}t(d)};document.addEventListener("visibilitychange",i,!0),document.addEventListener("webkitvisibilitychange",i,!0),document.addEventListener("mozvisibilitychange",i,!0),document.addEventListener("hasFocus",t,!0);try{/Firefox/.test(navigator.userAgent)?Object.defineProperty(document,"mozHidden",{get(){return!1}}):Object.defineProperty(document,"webkitHidden",{get(){return!1}})}catch{}}O(unsafeWindow),G(),Z(),document.readyState==="complete"||document.readyState==="loaded"||document.readyState==="interactive"?F():unsafeWindow.addEventListener("DOMContentLoaded",function(){F()})})();
