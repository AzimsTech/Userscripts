// ==UserScript==
// @name               IG Helper
// @namespace          https://github.snkms.com/
// @version            3.8.8
// @author             SN-Koarashi (5026)
// @match              https://*.instagram.com/*
// @grant              GM_info
// @grant              GM_addStyle
// @grant              GM_setValue
// @grant              GM_getValue
// @grant              GM_xmlhttpRequest
// @grant              GM_registerMenuCommand
// @grant              GM_unregisterMenuCommand
// @grant              GM_getResourceText
// @grant              GM_notification
// @grant              GM_openInTab
// @connect            i.instagram.com
// @connect            raw.githubusercontent.com
// @require            https://code.jquery.com/jquery-3.7.1.min.js#sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=
// @resource           INTERNAL_CSS https://raw.githubusercontent.com/SN-Koarashi/ig-helper/master/style.css
// @resource           LOCALE_MANIFEST https://raw.githubusercontent.com/SN-Koarashi/ig-helper/master/locale/manifest.json
// @supportURL         https://github.com/SN-Koarashi/ig-helper/
// @contributionURL    https://ko-fi.com/snkoarashi
// @icon               https://www.google.com/s2/favicons?domain=www.instagram.com&sz=32
// @compatible         firefox >= 100
// @compatible         chrome >= 100
// @compatible         edge >= 100
// @license            GPL-3.0-only
// @run-at             document-idle
// @downloadURL https://raw.githubusercontent.com/AzimsTech/Userscripts/release/release/IG20Helper.user.js
// @updateURL https://raw.githubusercontent.com/AzimsTech/Userscripts/release/release/IG20Helper.meta.js
// ==/UserScript==
(function(e){"use strict";const h={AUTO_RENAME:!0,CAPTURE_IMAGE_VIA_MEDIA_CACHE:!0,CHECK_FOR_UPDATE:!0,DIRECT_DOWNLOAD_ALL:!1,DIRECT_DOWNLOAD_STORY:!1,DIRECT_DOWNLOAD_VISIBLE_RESOURCE:!1,DISABLE_VIDEO_LOOPING:!1,FALLBACK_TO_BLOB_FETCH_IF_MEDIA_API_THROTTLED:!1,FORCE_FETCH_ALL_RESOURCES:!1,FORCE_RESOURCE_VIA_MEDIA:!1,HTML5_VIDEO_CONTROL:!1,MODIFY_RESOURCE_EXIF:!1,MODIFY_VIDEO_VOLUME:!1,NEW_TAB_ALWAYS_FORCE_MEDIA_IN_POST:!1,REDIRECT_CLICK_USER_STORY_PICTURE:!1,RENAME_PUBLISH_DATE:!0,SCROLL_BUTTON:!0,SKIP_VIEW_STORY_CONFIRM:!1},we={AUTO_RENAME:["RENAME_PUBLISH_DATE"],FORCE_RESOURCE_VIA_MEDIA:["FALLBACK_TO_BLOB_FETCH_IF_MEDIA_API_THROTTLED","NEW_TAB_ALWAYS_FORCE_MEDIA_IN_POST"]},ne="URLS_OF_IMAGES_TEMPORARILY_STORED",pe=720*60*1e3,ye=300,O={DOWNLOAD:'<svg xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" height="24px" viewBox="0 0 24 24" width="24px" fill="#000000"><g><rect fill="none" height="24" width="24"/></g><g><path d="M18,15v3H6v-3H4v3c0,1.1,0.9,2,2,2h12c1.1,0,2-0.9,2-2v-3H18z M17,11l-1.41-1.41L13,12.17V4h-2v8.17L8.41,9.59L7,11l5,5 L17,11z"/></g></svg>',NEW_TAB:'<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#000000"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/></svg>',THUMBNAIL:'<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#000000"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M19 5v14H5V5h14m0-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-4.86 8.86l-3 3.87L9 13.14 6 17h12l-3.86-5.14z"/></svg>',DOWNLOAD_ALL:'<svg xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" height="24px" viewBox="0 0 24 24" width="24px" fill="#000000"><g><rect fill="none" height="24" width="24"/></g><g><g><polygon points="18,6.41 16.59,5 12,9.58 7.41,5 6,6.41 12,12.41"/><polygon points="18,13 16.59,11.59 12,16.17 7.41,11.59 6,13 12,19"/></g></g></svg>',CLOSE:'<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#000000"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>',FULLSCREEN:'<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#000000"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>',TURN_DEG:'<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#1f1f1f"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M7.34 6.41L.86 12.9l6.49 6.48 6.49-6.48-6.5-6.49zM3.69 12.9l3.66-3.66L11 12.9l-3.66 3.66-3.65-3.66zm15.67-6.26C17.61 4.88 15.3 4 13 4V.76L8.76 5 13 9.24V6c1.79 0 3.58.68 4.95 2.05 2.73 2.73 2.73 7.17 0 9.9C16.58 19.32 14.79 20 13 20c-.97 0-1.94-.21-2.84-.61l-1.49 1.49C10.02 21.62 11.51 22 13 22c2.3 0 4.61-.88 6.36-2.64 3.52-3.51 3.52-9.21 0-12.72z"/></svg>'},Ie=250,Ce=GM_getResourceText("INTERNAL_CSS"),me=JSON.parse(GM_getResourceText("LOCALE_MANIFEST"));var l={videoVolume:GM_getValue("G_VIDEO_VOLUME")?GM_getValue("G_VIDEO_VOLUME"):1,tempFetchRateLimit:!1,fileRenameFormat:GM_getValue("G_RENAME_FORMAT")?GM_getValue("G_RENAME_FORMAT"):"%USERNAME%-%SOURCE_TYPE%-%SHORTCODE%-%YEAR%%MONTH%%DAY%_%HOUR%%MINUTE%%SECOND%_%ORIGINAL_NAME_FIRST%",registerMenuIds:[],locale:{},lang:GM_getValue("UI_LANGUAGE")||navigator.language||navigator.userLanguage,currentURL:location.href,firstStarted:!1,pageLoaded:!1,GL_registerEventList:[],GL_logger:[],GL_referrer:null,GL_postPath:null,GL_username:null,GL_repeat:null,GL_dataCache:{stories:{},highlights:{}},GL_observer:new MutationObserver(function(){se()}),GL_imageCache:GM_getValue(ne,{})};Ke(),GM_addStyle(Ce),K(),Re(l.lang).then(n=>{l.locale[l.lang]=n,ue(),K(),ce(300)}).catch(n=>{K(),ce(300),l.lang.startsWith("en")||console.error("getTranslationText catch error:",n)}),_("Script Loaded",GM_info.script.name,"version:",GM_info.script.version),Xe();var it=setInterval(function(){if(e("div#splash-screen").length>0&&!e("div#splash-screen").is(":hidden")||location.pathname.match(/^\/(explore(\/.*)?|challenge\/?.*|direct\/?.*|qr\/?|accounts\/.*|emails\/.*|language\/?.*?|your_activity\/?.*|settings\/help(\/.*)?$)$/ig)||!location.hostname.startsWith("www.")||location.pathname.startsWith("/auth_platform/codeentry/")||location.pathname.startsWith("/challenge/")||location.pathname.startsWith("/consent/")||location.pathname.startsWith("/accounts/")||(location.pathname.endsWith("/followers/")||location.pathname.endsWith("/following/"))&&e('body > div[class]:not([id^="mount"]) div div[role="dialog"]').length>0){l.pageLoaded=!1;return}if(l.currentURL!=location.href||!l.firstStarted||!l.pageLoaded){if(console.log("Main Timer","trigging"),clearInterval(l.GL_repeat),l.pageLoaded=!1,l.firstStarted=!0,l.currentURL=location.href,l.GL_observer.disconnect(),location.pathname.startsWith("/p/")||location.pathname.match(/^\/(.*?)\/(p|reel)\//ig)||location.pathname.startsWith("/reel/")){l.GL_dataCache.stories={},l.GL_dataCache.highlights={},_("isDialog");var n=setInterval(()=>{e(`body > div[class]:not([id^="mount"]) div div[role="dialog"] article,
                                section:visible > main > div > div > div > div > div > hr,
                                body > div[id^="mount"] section nav + div > article,
                                section:visible > main > div > div > article > div > div > div > div > div > header
                            `).length>0&&(clearInterval(n),setTimeout(()=>{se(!1)},15))},100);l.pageLoaded=!0}if(location.pathname.startsWith("/reels/")&&(_("isReelsPage"),setTimeout(()=>{$(!1)},150),l.pageLoaded=!0),location.pathname==="/"){l.GL_dataCache.stories={},l.GL_dataCache.highlights={};let a=l.GL_referrer?.match(/^\/(stories|highlights)\//ig)!=null;_("isHomepage",a),setTimeout(()=>{se(!1,a);const o=e('div[id^="mount"] > div > div div > section > main div:not([class]):not([style]) > div > article')?.parent()[0];o&&l.GL_observer.observe(o,{childList:!0})},150),l.pageLoaded=!0}e("header > *[class]:first-child img[alt]").length&&location.pathname.match(/^(\/)([0-9A-Za-z\.\-_]+)\/?(tagged|reels|saved)?\/?$/ig)&&!location.pathname.match(/^(\/explore\/?$|\/stories(\/.*)?$|\/p\/)/ig)&&(_("isProfile"),setTimeout(()=>{Oe(!1)},150),l.pageLoaded=!0),l.pageLoaded||(location.pathname.startsWith("/stories/highlights/")?(l.GL_dataCache.highlights={},_("isHighlightsStory"),Q(!1),l.GL_repeat=setInterval(()=>{Z(!1)},Ie),e(".IG_DWHISTORY").length&&setTimeout(()=>{if(h.SKIP_VIEW_STORY_CONFIRM){var a=e('div[id^="mount"] section:last-child > div > div div[role="button"]').filter(function(){return e(this).children().length===0&&this.textContent.trim()!==""});a?.trigger("click")}l.pageLoaded=!0},150)):location.pathname.startsWith("/stories/")?(_("isStory"),(e('div[id^="mount"] section > div > a[href="/"]').length>0||e('div[id^="mount"] section > div > a[href^="/?hl="]').length>0)&&(e(".IG_DWSTORY").remove(),e(".IG_DWNEWTAB").remove(),e(".IG_DWSTORY_THUMBNAIL").length&&e(".IG_DWSTORY_THUMBNAIL").remove(),V(!1),setTimeout(()=>{V(!1)},150)),e(".IG_DWSTORY").length&&setTimeout(()=>{if(h.SKIP_VIEW_STORY_CONFIRM){var a=e('div[id^="mount"] section:last-child > div > div div[role="button"]').filter(function(){return e(this).children().length===0&&this.textContent.trim()!==""});a?.trigger("click")}l.pageLoaded=!0},150)):(l.pageLoaded=!1,e(".IG_DWSTORY").length&&e(".IG_DWSTORY").remove(),e(".IG_DWSTORY_ALL").length&&e(".IG_DWSTORY_ALL").remove(),e(".IG_DWNEWTAB").length&&e(".IG_DWNEWTAB").remove(),e(".IG_DWSTORY_THUMBNAIL").length&&e(".IG_DWSTORY_THUMBNAIL").remove(),e(".IG_DWHISTORY").length&&e(".IG_DWHISTORY").remove(),e(".IG_DWHISTORY_ALL").length&&e(".IG_DWHISTORY_ALL").remove(),e(".IG_DWHINEWTAB").length&&e(".IG_DWHINEWTAB").remove(),e(".IG_DWHISTORY_THUMBNAIL").length&&e(".IG_DWHISTORY_THUMBNAIL").remove())),ce(300),l.GL_referrer=new URL(location.href).pathname}},Ie);async function Ne(){E(!0);let n=new Date().getTime(),a=Math.floor(n/1e3),o=location.href.replace(/\/$/ig,"").split("/").at(-1),i=await oe(o),t=i.data.reels_media[0].owner.username;if(h.DIRECT_DOWNLOAD_STORY){let s=0;Y(s,i.data.reels_media[0].items.length),i.data.reels_media[0].items.forEach((d,r)=>{setTimeout(()=>{h.RENAME_PUBLISH_DATE&&(a=d.taken_at_timestamp),d.display_resources.sort(function(c,I){return c.config_width<I.config_width?1:c.config_width>I.config_width?-1:0}),d.is_video?A(d.video_resources[0].src,t,"highlights",a,"mp4",d.id).then(()=>{Y(++s,i.data.reels_media[0].items.length)}):A(d.display_resources[0].src,t,"highlights",a,"jpg",d.id).then(()=>{Y(++s,i.data.reels_media[0].items.length)})},100*r)})}else S(!1,!0),Pe(i,"highlights")}async function Q(n,a){var o=e('body > div section:visible a[href^="/"]').filter(function(){return e(this).attr("href").split("/").filter(i=>i.length>0).length===1}).first().attr("href").split("/").filter(i=>i.length>0).at(0);if(n){let i=new Date().getTime(),t=Math.floor(i/1e3),s=location.href.replace(/\/$/ig,"").split("/").at(-1),d=e("body > div section._ac0a header._ac0k > ._ac3r ._ac3n ._ac3p[style]").length||e("body > div section:visible > div > div:not([class]) > div > div div.x1ned7t2.x78zum5 div.x1caxmr6").length||e("body > div div:not([hidden]) section:visible > div div[style]:not([class]) > div").find("div div.x1ned7t2.x78zum5 div.x1caxmr6").length,r=0;if(E(!0),l.GL_dataCache.highlights[s]){_("Fetch from memory cache:",s);let c=l.GL_dataCache.highlights[s].data.reels_media[0].items.length;o=l.GL_dataCache.highlights[s].data.reels_media[0].owner.username,r=l.GL_dataCache.highlights[s].data.reels_media[0].items[c-d]}else{let c=await oe(s),I=c.data.reels_media[0].items.length;o=c.data.reels_media[0].owner.username,r=c.data.reels_media[0].items[I-d],l.GL_dataCache.highlights[s]=c}if(_("onHighlightsStory",s,l.GL_dataCache.highlights[s]),h.RENAME_PUBLISH_DATE&&(t=r.taken_at_timestamp),h.CAPTURE_IMAGE_VIA_MEDIA_CACHE){const c=X(r.id);if(c&&!l.GL_dataCache.highlights[s].data.reels_media[0].items.filter(I=>I.id===r.id).at(0).is_video){_("[Restore Cached onHighlight]",r.id),a?w(c):A(c,o,"stories",t,"jpg",r.id);return}}if(h.FORCE_RESOURCE_VIA_MEDIA&&!l.tempFetchRateLimit){let c=await z(r.id);c.status==="ok"?c.items[0].video_versions?a?w(c.items[0].video_versions[0].url):A(c.items[0].video_versions[0].url,o,"highlights",t,"mp4",c.items[0].id):a?w(c.items[0].image_versions2.candidates[0].url):A(c.items[0].image_versions2.candidates[0].url,o,"highlights",t,"jpg",c.items[0].id):(h.FALLBACK_TO_BLOB_FETCH_IF_MEDIA_API_THROTTLED?(delete l.GL_dataCache.highlights[s],l.tempFetchRateLimit=!0,Q(!0,a)):alert("Fetch failed from Media API. API response message: "+c.message),_(c))}else r.is_video?a?w(r.video_resources.at(-1).src,o):A(r.video_resources.at(-1).src,o,"highlights",t,"mp4",r.id):a?w(r.display_resources.at(-1).src,o):A(r.display_resources.at(-1).src,o,"highlights",t,"jpg",r.id),l.tempFetchRateLimit=!1;E(!1)}else if(!e(".IG_DWHISTORY").length){let i=null;if(e("body > div section._ac0a").length>0?i=e("body > div section:visible._ac0a"):(i=e("body > div section:visible > div > div[style]:not([class])"),i.css("position","relative")),i.length===0){let t=e("body > div div:not([hidden]) section:visible > div div[class][style] > div[style]:not([class])"),s=0;t.each(function(){e(this).width()>s&&(s=e(this).width(),i=e(this).children("div").first())})}if(i!=null){i.append(`<div data-ih-locale-title="DW" title="${u("DW")}" class="IG_DWHISTORY">${O.DOWNLOAD}</div>`),i.append(`<div data-ih-locale-title="NEW_TAB" title="${u("NEW_TAB")}" class="IG_DWHINEWTAB">${O.NEW_TAB}</div>`);let t=F(o);t.length>1&&i.append(`<div data-ih-locale-title="DW_ALL" title="${u("DW_ALL")}" class="IG_DWHISTORY_ALL">${O.DOWNLOAD_ALL}</div>`);let s=t.parents("div[class]").find("time[datetime]")?.attr("title");s!=null&&t.parents("div[class]").find("time[datetime]").text(s),i.find("img[referrerpolicy]").each(function(){e(this).on("load",function(){e(this).data("remove-thumbnail")||(i.find(".IG_DWHISTORY_THUMBNAIL").length===0?(e(this).attr("data-remove-thumbnail",!0),e(".IG_DWHISTORY_THUMBNAIL").remove(),_("(highlight) Manually removing thumbnail button")):(e(this).attr("data-remove-thumbnail",!0),_("(highlight) Thumbnail button is not present for this picture")))})})}}}async function Z(n){if(n){let a=new Date().getTime(),o=Math.floor(a/1e3),i=location.href.replace(/\/$/ig,"").split("/").at(-1),t="",s=e("body > div section._ac0a header._ac0k > ._ac3r ._ac3n ._ac3p[style]").length||e("body > div section:visible > div > div:not([class]) > div > div div.x1ned7t2.x78zum5 div.x1caxmr6").length||e("body > div div:not([hidden]) section:visible > div div[style]:not([class]) > div").find("div div.x1ned7t2.x78zum5 div.x1caxmr6").length,d="";if(E(!0),l.GL_dataCache.highlights[i]){_("Fetch from memory cache:",i);let r=l.GL_dataCache.highlights[i].data.reels_media[0].items.length;t=l.GL_dataCache.highlights[i].data.reels_media[0].owner.username,d=l.GL_dataCache.highlights[i].data.reels_media[0].items[r-s]}else{let r=await oe(i),c=r.data.reels_media[0].items.length;t=r.data.reels_media[0].owner.username,d=r.data.reels_media[0].items[c-s],l.GL_dataCache.highlights[i]=r}if(h.RENAME_PUBLISH_DATE&&(o=d.taken_at_timestamp),h.FORCE_RESOURCE_VIA_MEDIA&&!l.tempFetchRateLimit){let r=await z(d.id);r.status==="ok"?A(r.items[0].image_versions2.candidates[0].url,t,"highlights",o,"jpg",i):(h.FALLBACK_TO_BLOB_FETCH_IF_MEDIA_API_THROTTLED?(delete l.GL_dataCache.highlights[i],l.tempFetchRateLimit=!0,Z(!0)):alert("Fetch failed from Media API. API response message: "+r.message),_(r))}else A(d.display_resources.at(-1).src,t,"highlights",o,"jpg",i),l.tempFetchRateLimit=!1;E(!1)}else if(e("body > div section video.xh8yej3").length){if(!e(".IG_DWHISTORY_THUMBNAIL").length){let a=null;if(e("body > div section._ac0a").length>0?a=e("body > div section:visible._ac0a"):(a=e("body > div section:visible > div > div[style]:not([class])"),a.css("position","relative")),a.length===0){let o=e("body > div div:not([hidden]) section:visible > div div[class][style] > div[style]:not([class])"),i=0;o.each(function(){e(this).width()>i&&(i=e(this).width(),a=e(this).children("div").first())})}a?.append(`<div data-ih-locale-title="VIDEO_THUMBNAIL" title="${u("VIDEO_THUMBNAIL")}" class="IG_DWHISTORY_THUMBNAIL">${O.THUMBNAIL}</div>`)}}else e(".IG_DWHISTORY_THUMBNAIL").remove()}function se(n,a){if(a===!0&&(_("hasReferrer","regenerated"),e('article[data-snig="canDownload"], div[data-snig="canDownload"]').filter(function(){return e(this).find(".IG_DW_MAIN").length===0}).removeAttr("data-snig")),n==!1){let t=0;var o=setInterval(()=>{(t>100||e('article[data-snig="canDownload"], section:visible > main > div > div[data-snig="canDownload"] > div > div > div > hr, div[id^="mount"] > div > div > div.x1n2onr6.x1vjfegm div[data-snig="canDownload"]').length>0)&&(clearInterval(o),t>100&&console.warn("onReadyMyDW() Timer","maximum number of repetitions reached, terminated")),_("onReadyMyDW() Timer","repeating to call detection createDownloadButton()"),ve(),t++},50)}else ve()}function ge(n){h.DISABLE_VIDEO_LOOPING&&n.find("video").each(function(){e(this).on("ended",function(){e(this).data("loop")||(e(this).attr("data-loop",!0),this.pause(),_("(post) Added video event listener #loop"))})}),h.MODIFY_VIDEO_VOLUME&&n.find("video").each(function(){e(this).on("play playing",function(){e(this).data("modify")||(e(this).attr("data-modify",!0),this.volume=l.videoVolume,_("(post) Added video event listener #modify"))})}),h.HTML5_VIDEO_CONTROL&&n.find("video").each(function(){if(!e(this).data("controls")){let i=e(this);_("(post) Added video html5 contorller #modify"),h.MODIFY_VIDEO_VOLUME&&(this.volume=l.videoVolume,e(this).on("loadstart",function(){this.volume=l.videoVolume})),e(this).on("contextmenu",function(t){t.preventDefault(),i.css("z-index","-1"),i.removeAttr("controls")}),e(this).parent().find("video + div > div").first().on("contextmenu",function(t){t.preventDefault(),i.css("z-index","2"),i.attr("controls",!0)}),e(this).on("volumechange",function(){let t=e(this).parent().find("video + div > div").find('button[type="button"], div[role="button"]').filter(function(d){return e(this).width()<=64&&e(this).height()<=64&&e(this).find('svg > path[d^="M16.636 7.028a1.5"], svg > path[d^="M1.5 13.3c-.8"]').length>0});var s=t.find('svg > path[d^="M16.636"]').length===0;this.muted!=s&&(this.volume=l.videoVolume,t?.trigger("click")),e(this).attr("data-completed")&&(l.videoVolume=this.volume,GM_setValue("G_VIDEO_VOLUME",this.volume)),this.volume==l.videoVolume&&e(this).attr("data-completed",!0)}),e(this).css("position","absolute"),e(this).css("z-index","2"),e(this).attr("data-controls",!0),e(this).attr("controls",!0)}});var a=n.find("video"),o=n.find("video + div > div").first();q(a,o,"post","bottom")}function ve(){e("article, section:visible > main > div > div > div > div > div > hr").map(function(n){return e(this).is("section:visible > main > div > div > div > div > div > hr")?e(this).parent().parent().parent().parent()[0]:this}).filter(function(){return e(this).height()>0&&e(this).width()>0}).each(function(n){if(!e(this).attr("data-snig")&&!e(this).hasClass("x1iyjqo2")&&!e(this).children("article")?.hasClass("x1iyjqo2")&&e(this).parents("div#scrollview").length===0){_("Found post container",e(this));const t=e(this),s=this.tagName,d="._acay ._acaz";var a;if(s==="DIV"&&n!=0)return;const r=t.children("div").children("div");if(r.length===0)return;if(_("Found insert point",r),t.find("._acay").length>0){t.find("._acay + .x24i39r").length>0&&t.find("._acay + .x24i39r").css("top","37px");const m=t.find("._acay").first().parent()[0];var o=new MutationObserver(function(){t.find("._acay + .x24i39r").css("top","37px")});o.observe(m,{childList:!0})}r.eq(s==="DIV"?0:r.length-2).append('<div class="button_wrapper">');const c=`<div data-ih-locale-title="DW" title="${u("DW")}" class="IG_DW_MAIN">${O.DOWNLOAD}</div>`,I=`<div data-ih-locale-title="NEW_TAB" title="${u("NEW_TAB")}" class="IG_NEWTAB_MAIN">${O.NEW_TAB}</div>`,p=`<div data-ih-locale-title="VIDEO_THUMBNAIL" title="${u("VIDEO_THUMBNAIL")}" class="IG_THUMBNAIL_MAIN">${O.THUMBNAIL}</div>`,f=`<div data-ih-locale-title="IMAGE_VIEWER" title="${u("IMAGE_VIEWER")}" class="IG_IMAGE_VIEWER">${O.FULLSCREEN}</div>`;if(r.find(".button_wrapper").append(c),t.find(d).length>1&&h.DIRECT_DOWNLOAD_VISIBLE_RESOURCE&&!h.DIRECT_DOWNLOAD_ALL){const m=`<div data-ih-locale-title="DW_ALL" title="${u("DW_ALL")}" class="IG_DW_ALL_MAIN">${O.DOWNLOAD_ALL}</div>`;r.find(".button_wrapper").append(m)}r.find(".button_wrapper").append(I),setTimeout(()=>{if(r.eq(s==="DIV"?0:r.length-2).find("div > ul li._acaz").length===0)r.find("video").length>0?r.find(".button_wrapper").append(p):(a=t.find("img").filter(function(){return e(this).width()>200&&e(this).height()>200}).attr("src"),r.find(".button_wrapper").append(f));else{const m=(G,L)=>{G.forEach(T=>{if(T.isIntersecting){var D=e(T.target);r.find(".IG_THUMBNAIL_MAIN")?.remove(),r.find(".IG_IMAGE_VIEWER")?.remove(),D.find("video").length>0?(r.find(".IG_THUMBNAIL_MAIN").length===0&&r.find(".button_wrapper").append(p),ge(t)):(a=D.find("img").attr("src"),r.find(".button_wrapper").append(f))}})},v=new IntersectionObserver(m,{root:t.find("div > ul._acay").first().parent().parent().parent()[0],rootMargin:"0px",threshold:.1}),P=new MutationObserver(function(G,L){var T=G.at(0)?.target;e(T).find("li._acaz").each(function(){v.observe(this)})});t.find("div > ul li._acaz").each(function(){v.observe(this)});const U=r.eq(s==="DIV"?0:r.length-2).find("div > ul li._acaz")?.parent()[0],R=r.eq(s==="DIV"?0:r.length-2).find("div > ul li._acaz")?.parent().parent()[0];U&&P.observe(U,{childList:!0}),R&&P.observe(R,{attributes:!0})}},50),r.css("position","relative"),ge(t),l.GL_registerEventList.push({element:this,trigger:[".IG_THUMBNAIL_MAIN",".IG_NEWTAB_MAIN",".IG_DW_ALL_MAIN",".IG_DW_MAIN",".IG_IMAGE_VIEWER"]}),e(this).on("click",".IG_IMAGE_VIEWER",function(){a!=null?qe(a):alert("Cannot find resource url.")}),e(this).on("click",".IG_THUMBNAIL_MAIN",function(){E(!0),l.GL_username=t.attr("data-username"),l.GL_postPath=location.pathname.replace(/\/$/,"").split("/").at(-1)||t.find('a[href^="/p/"]').first().attr("href").split("/").at(2)||e(this).parent().parent().parent().children("div:last-child").children("div").children("div:last-child").find('a[href^="/p/"]').last().attr("href").split("/").at(2);var m=re(t);S(!0,!1),N(l.GL_postPath,".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY","").then(()=>{let v=setInterval(()=>{if(e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY a").length>0){clearInterval(v);var P=e('.IG_POPUP_DIG .IG_POPUP_DIG_BODY a[data-globalindex="'+(m+1)+'"]')?.parent().find(".videoThumbnail")?.first();P!=null&&P.length>0?P.trigger("click"):alert("Cannot find thumbnail URL."),E(!1),e(".IG_POPUP_DIG").remove()}},250)})}),e(this).on("click",".IG_NEWTAB_MAIN",function(){E(!0),l.GL_username=t.attr("data-username"),l.GL_postPath=location.pathname.replace(/\/$/,"").split("/").at(-1)||t.find('a[href^="/p/"]').first().attr("href").split("/").at(2)||e(this).parent().parent().parent().children("div:last-child").children("div").children("div:last-child").find('a[href^="/p/"]').last().attr("href").split("/").at(2);var m=re(t);S(!0,!1),N(l.GL_postPath,".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY","").then(()=>{let v=setInterval(()=>{if(e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY a").length>0){clearInterval(v);var P=e('.IG_POPUP_DIG .IG_POPUP_DIG_BODY a[data-globalindex="'+(m+1)+'"]');if(h.FORCE_RESOURCE_VIA_MEDIA&&h.NEW_TAB_ALWAYS_FORCE_MEDIA_IN_POST)de(P.first()[0],!0);else{let R=P?.attr("data-href");if(R){var U=new URL(R);U.host="scontent.cdninstagram.com",w(U.href)}else alert("Cannot find open tab URL.")}E(!1),e(".IG_POPUP_DIG").remove()}},250)})}),e(this).on("click",".IG_DW_ALL_MAIN",async function(){l.GL_username=t.attr("data-username"),l.GL_postPath=location.pathname.replace(/\/$/,"").split("/").at(-1)||t.find('a[href^="/p/"]').first().attr("href").split("/").at(2)||e(this).parent().parent().parent().children("div:last-child").children("div").children("div:last-child").find('a[href^="/p/"]').last().attr("href").split("/").at(2),S(h.DIRECT_DOWNLOAD_ALL,!0),e("#article-id").html(`<a href="https://www.instagram.com/p/${l.GL_postPath}">${l.GL_postPath}</a>`),e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY a").each(function(){e(this).wrap("<div></div>"),e(this).before('<label class="inner_box_wrapper"><input class="inner_box" type="checkbox"><span></span></label>'),e(this).after(`<div data-ih-locale-title="NEW_TAB" title="${u("NEW_TAB")}" class="newTab">${O.NEW_TAB}</div>`),e(this).attr("data-name")=="video"&&e(this).after(`<div data-ih-locale-title="VIDEO_THUMBNAIL" title="${u("VIDEO_THUMBNAIL")}" class="videoThumbnail">${O.THUMBNAIL}</div>`)}),N(l.GL_postPath,".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY",u("LOAD_BLOB_MULTIPLE")).then(()=>{let m=setInterval(()=>{e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY a").length>0&&(clearInterval(m),e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY a").each(function(){e(this).trigger("click")}),e(".IG_POPUP_DIG").remove())},250)})}),e(this).on("click",".IG_DW_MAIN",async function(){if(l.GL_username=t.attr("data-username"),l.GL_postPath=location.pathname.replace(/\/$/,"").split("/").at(-1)||t.find('a[href^="/p/"]').first().attr("href").split("/").at(2)||e(this).parent().parent().parent().children("div:last-child").children("div").children("div:last-child").find('a[href^="/p/"]').last().attr("href").split("/").at(2),S(h.DIRECT_DOWNLOAD_ALL,!0),e("#article-id").html(`<a href="https://www.instagram.com/p/${l.GL_postPath}">${l.GL_postPath}</a>`),h.DIRECT_DOWNLOAD_VISIBLE_RESOURCE){E(!0),ke(!0);var m=re(e(this).parent().parent().parent());N(l.GL_postPath,".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY","").then(()=>{let G=setInterval(()=>{if(e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY a").length>0){clearInterval(G);var L=e('.IG_POPUP_DIG .IG_POPUP_DIG_BODY a[data-globalindex="'+(m+1)+'"]')?.attr("data-href");L?(E(!1),e('.IG_POPUP_DIG .IG_POPUP_DIG_BODY a[data-globalindex="'+(m+1)+'"]')?.trigger("click")):alert("Cannot find download URL."),e(".IG_POPUP_DIG").remove()}},250)});return}if(!h.DIRECT_DOWNLOAD_ALL){var v=0,P=e(this).parent().parent().find(d).length,U=h.FORCE_FETCH_ALL_RESOURCES,R=new Date(e(this).parent().parent().parent().find("a[href] time[datetime]").filter(function(){let G=e(this).parents("a[href]").attr("href");return G?.startsWith("/p/")||G?.match(/\/([\w.\-_]+)\/p\//ig)!=null}).first().attr("datetime")).getTime();if(P)e(this).parent().parent().find(d).each(function(){let G=e(this).parent().parent().parent().find("video");G&&G.attr("src")&&(U=!0)}),U||h.FORCE_RESOURCE_VIA_MEDIA?N(l.GL_postPath,".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY",u("LOAD_BLOB_MULTIPLE")):(e(this).parent().parent().find(d).each(function(){v++;let G=e(this).find("video"),L=e(this).find("._aagv img"),T=L.attr("srcset")?L.attr("srcset").split(" ")[0]:L.attr("src");G&&G.attr("src")&&(U=!0),L&&T&&e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY").append(`<a datetime="${R}" data-needed="direct" data-path="${l.GL_postPath}" data-name="photo" data-type="jpg" data-globalIndex="${v}" href="javascript:;" data-href="${T}"><img width="100" src="${T}" /><br/>- <span data-ih-locale="IMG">${u("IMG")}</span> ${v} -</a>`)}),U&&N(l.GL_postPath,".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY",u("LOAD_BLOB_RELOAD")));else if(h.FORCE_RESOURCE_VIA_MEDIA)N(l.GL_postPath,".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY",u("LOAD_BLOB_MULTIPLE"));else{v++;let G=e(this).parent().parent().parent().find("video"),L=e(this).parent().parent().parent().find("._aagv img"),T=L.attr("srcset")?L.attr("srcset").split(" ")[0]:L.attr("src");G&&G.attr("src")&&N(l.GL_postPath,".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY",u("LOAD_BLOB_ONE")),L&&T&&e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY").append(`<a datetime="${R}" data-needed="direct" data-path="${l.GL_postPath}" data-name="photo" data-type="jpg" data-globalIndex="${v}" href="javascript:;" href="" data-href="${T}"><img width="100" src="${T}" /><br/>- <span data-ih-locale="IMG">${u("IMG")}</span> ${v} -</a>`)}}e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY a").each(function(){e(this).wrap("<div></div>"),e(this).before('<label class="inner_box_wrapper"><input class="inner_box" type="checkbox"><span></span></label>'),e(this).after(`<div data-ih-locale-title="NEW_TAB" title="${u("NEW_TAB")}" class="newTab">${O.NEW_TAB}</div>`),e(this).attr("data-name")=="video"&&e(this).after(`<div data-ih-locale-title="VIDEO_THUMBNAIL" title="${u("VIDEO_THUMBNAIL")}" class="videoThumbnail">${O.THUMBNAIL}</div>`)}),h.DIRECT_DOWNLOAD_ALL&&N(l.GL_postPath,".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY",u("LOAD_BLOB_MULTIPLE")).then(()=>{let G=setInterval(()=>{e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY a").length>0&&(clearInterval(G),e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY a").each(function(){e(this).trigger("click")}),e(".IG_POPUP_DIG").remove())},250)})});var i=e(this).find("header > div:last-child > div:first-child span a").first().text()||e(this).find('a[href^="/"]').filter(function(){return e(this)?.text()?.length>0}).first().text();e(this).attr("data-snig","canDownload"),e(this).attr("data-username",i)}})}function De(n){var a=n.shortcode_media??n;return a.owner==null&&a.user!=null&&(a.owner=a.user),a.owner==null&&(_("carousel_media:","undefined username"),alert("carousel_media: undefined username")),a}async function N(n,a,o){try{e(`${a} a`).remove(),e(a).append('<p id="_SNLOAD">'+o+"</p>");let i=await Ee(n),t=De(i.data);if(i.type==="query_hash"){let s=1;if(t.__typename=="GraphVideo"&&t.video_url&&(e(a).append(`<a media-id="${t.id}" datetime="${t.taken_at_timestamp}" data-blob="true" data-needed="direct" data-path="${t.shortcode}" data-name="video" data-type="mp4" data-username="${t.owner.username}" data-globalIndex="${s}" href="javascript:;" data-href="${t.video_url}"><img width="100" src="${t.display_resources[1].src}" /><br/>- <span data-ih-locale="VID">${u("VID")}</span> ${s} -</a>`),s++),t.__typename=="GraphImage"&&(e(a).append(`<a media-id="${t.id}" datetime="${t.taken_at_timestamp}" data-blob="true" data-needed="direct" data-path="${t.shortcode}" data-name="photo" data-type="jpg" data-username="${t.owner.username}" data-globalIndex="${s}" href="javascript:;" data-href="${t.display_resources[t.display_resources.length-1].src}"><img width="100" src="${t.display_resources[1].src}" /><br/>- <span data-ih-locale="IMG">${u("IMG")}</span> ${s} -</a>`),s++),t.__typename=="GraphSidecar"&&t.edge_sidecar_to_children)for(let d of t.edge_sidecar_to_children.edges)d.node.__typename=="GraphVideo"&&e(a).append(`<a media-id="${d.node.id}" datetime="${t.taken_at_timestamp}" data-blob="true" data-needed="direct" data-path="${t.shortcode}" data-name="video" data-type="mp4" data-username="${t.owner.username}" data-globalIndex="${s}" href="javascript:;" data-href="${d.node.video_url}"><img width="100" src="${d.node.display_resources[1].src}" /><br/>- <span data-ih-locale-title="VID">${u("VID")}</span> ${s} -</a>`),d.node.__typename=="GraphImage"&&e(a).append(`<a media-id="${d.node.id}" datetime="${t.taken_at_timestamp}" data-blob="true" data-needed="direct" data-path="${t.shortcode}" data-name="photo" data-type="jpg" data-username="${t.owner.username}" data-globalIndex="${s}" href="javascript:;" data-href="${d.node.display_resources[d.node.display_resources.length-1].src}"><img width="100" src="${d.node.display_resources[1].src}" /><br/>- <span data-ih-locale="IMG">${u("IMG")}</span> ${s} -</a>`),s++}else if(t.carousel_media)_("carousel_media"),t.carousel_media.forEach((s,d)=>{let r=d+1;s.video_versions==null?(s.image_versions2.candidates.sort(function(c,I){let p=new URL(c.url).searchParams.get("stp"),f=new URL(I.url).searchParams.get("stp");if(p&&f){if(p.length>f.length)return 1;if(p.length<f.length)return-1}else{if(c.width<I.width)return 1;if(c.width>I.width)return-1}return 0}),e(a).append(`<a media-id="${s.pk}" datetime="${s.taken_at}" data-blob="true" data-needed="direct" data-path="${t.code}" data-name="photo" data-type="jpg" data-username="${t.owner.username}" data-globalIndex="${r}" href="javascript:;" data-href="${s.image_versions2.candidates[0].url}"><img width="100" src="${s.image_versions2.candidates[0].url}" /><br/>- <span data-ih-locale="IMG">${u("IMG")}</span> ${r} -</a>`)):e(a).append(`<a media-id="${s.pk}" datetime="${s.taken_at}" data-blob="true" data-needed="direct" data-path="${t.code}" data-name="video" data-type="mp4" data-username="${t.owner.username}" data-globalIndex="${r}" href="javascript:;" data-href="${s.video_versions[0].url}"><img width="100" src="${s.image_versions2.candidates[0].url}" /><br/>- <span data-ih-locale="VID">${u("VID")}</span> ${r} -</a>`)});else{let s=1;t.video_versions==null?(t.image_versions2.candidates.sort(function(d,r){let c=new URL(d.url).searchParams.get("stp"),I=new URL(r.url).searchParams.get("stp");if(c&&I){if(c.length>I.length)return 1;if(c.length<I.length)return-1}else{if(d.width<r.width)return 1;if(d.width>r.width)return-1}return 0}),e(a).append(`<a media-id="${t.pk}" datetime="${t.taken_at}" data-blob="true" data-needed="direct" data-path="${t.code}" data-name="photo" data-type="jpg" data-username="${t.owner.username}" data-globalIndex="${s}" href="javascript:;" data-href="${t.image_versions2.candidates[0].url}"><img width="100" src="${t.image_versions2.candidates[0].url}" /><br/>- <span data-ih-locale="IMG">${u("IMG")}</span> ${s} -</a>`)):e(a).append(`<a media-id="${t.pk}" datetime="${t.taken_at}" data-blob="true" data-needed="direct" data-path="${t.code}" data-name="video" data-type="mp4" data-username="${t.owner.username}" data-globalIndex="${s}" href="javascript:;" data-href="${t.video_versions[0].url}"><img width="100" src="${t.image_versions2.candidates[0].url}" /><br/>- <span data-ih-locale="VID">${u("VID")}</span> ${s} -</a>`)}e("#_SNLOAD").remove(),e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY a").each(function(){e(this).wrap("<div></div>"),e(this).before('<label class="inner_box_wrapper"><input class="inner_box" type="checkbox"><span></span></label>'),e(this).after(`<div data-ih-locale-title="NEW_TAB" title="${u("NEW_TAB")}" class="newTab">${O.NEW_TAB}</div>`),e(this).attr("data-name")=="video"&&e(this).after(`<div data-ih-locale-title="VIDEO_THUMBNAIL" title="${u("VIDEO_THUMBNAIL")}" class="videoThumbnail">${O.THUMBNAIL}</div>`)})}catch(i){_("createMediaListDOM",i)}}function re(n){var a=0,o=n.find(".x1iyjqo2 > div > div:last-child > div");return(o==null||!o.hasClass("_acnb"))&&(o=n.find("._aatk > div > div:last-child").eq(0).children("div")),o.filter("._acnb").each(function(i){e(this).hasClass("_acnf")&&(a=i)}),a}async function Oe(n){if(n){E(!0);let a=new Date().getTime(),o=Math.floor(a/1e3),i=location.pathname.replaceAll(/(reels|tagged)\/$/ig,"").split("/").filter(s=>s.length>0).at(-1),t=await k(i);try{let s=await xe(t.user.pk);A(s,i,"avatar",o,"jpg")}catch{A(t.user.profile_pic_url,i,"avatar",o,"jpg")}E(!1)}else if(!e(".IG_DWPROFILE").length){let a=setInterval(()=>{if(e(".IG_DWPROFILE").length){clearInterval(a);return}e("header > *[class]:first-child img[alt][draggable]").parent().parent().append(`<div data-ih-locale-title="DW" title="${u("DW")}" class="IG_DWPROFILE">${O.DOWNLOAD}</div>`),e("header > *[class]:first-child img[alt][draggable]").parent().parent().css("position","relative"),e("header > *[class]:first-child img[alt]:not([draggable])").parent().parent().parent().append(`<div data-ih-locale-title="DW" title="${u("DW")}" class="IG_DWPROFILE">${O.DOWNLOAD}</div>`),e("header > *[class]:first-child img[alt]:not([draggable])").parent().parent().parent().css("position","relative")},150)}}async function $(n,a,o){try{if(n){E(!0);let t=location.href.split("?").at(0).split("instagram.com/reels/").at(-1).replaceAll("/",""),s=await Ee(t),d=De(s.data),r=new Date().getTime();h.RENAME_PUBLISH_DATE&&(s.type==="query_hash"?r=d.taken_at_timestamp:r=d.taken_at),s.type==="query_hash"?a&&d.is_video?o?w(d.video_url):A(d.video_url,d.owner.username,"reels",r,"mp4",t):o?w(d.display_resources.at(-1).src):A(d.display_resources.at(-1).src,d.owner.username,"reels",r,"jpg",t):a&&d.video_versions!=null?o?w(d.video_versions[0].url):A(d.video_versions[0].url,d.owner.username,"reels",r,"mp4",t):o?w(d.image_versions2.candidates[0].url):A(d.image_versions2.candidates[0].url,d.owner.username,"reels",r,"jpg",t),E(!1)}else var i=setInterval(()=>{e('section > main[role="main"] > div div.x1qjc9v5 video').length>0&&(clearInterval(i),h.SCROLL_BUTTON&&(e("#scrollWrapper").remove(),e('section > main[role="main"]').append('<section id="scrollWrapper"></section>'),e('section > main[role="main"] > #scrollWrapper').append('<div class="button-up"><div></div></div>'),e('section > main[role="main"] > #scrollWrapper').append('<div class="button-down"><div></div></div>'),e('section > main[role="main"] > #scrollWrapper > .button-up').on("click",function(){e('section > main[role="main"] > div')[0].scrollBy({top:-30,behavior:"smooth"})}),e('section > main[role="main"] > #scrollWrapper > .button-down').on("click",function(){e('section > main[role="main"] > div')[0].scrollBy({top:30,behavior:"smooth"})})),e('section > main[role="main"] > div[tabindex], section > main[role="main"] > div[class]').children("div").each(function(){if(e(this).children().length>0&&!e(this).children().find(".IG_REELS").length){var t=e(this);e(this).children().css("position","relative"),e(this).children().append(`<div data-ih-locale-title="DW" title="${u("DW")}" class="IG_REELS">${O.DOWNLOAD}</div>`),e(this).children().append(`<div data-ih-locale-title="NEW_TAB" title="${u("NEW_TAB")}" class="IG_REELS_NEWTAB">${O.NEW_TAB}</div>`),e(this).children().append(`<div data-ih-locale-title="VIDEO_THUMBNAIL" title="${u("VIDEO_THUMBNAIL")}" class="IG_REELS_THUMBNAIL">${O.THUMBNAIL}</div>`),h.DISABLE_VIDEO_LOOPING&&e(this).find("video").each(function(){e(this).on("ended",function(){if(!e(this).data("loop")){let r=e(this).next().find('div[role="presentation"] > div svg > path[d^="M5.888"]').parents('button[role="button"], div[role="button"]');r.length>0?(e(this).attr("data-loop",!0),r.trigger("click"),_("Adding video event listener #loop, then paused click()")):(e(this).attr("data-loop",!0),e(this).parent().find(".xpgaw4o").removeAttr("style"),this.pause(),_("Adding video event listener #loop, then paused pause()"))}})}),h.HTML5_VIDEO_CONTROL&&e(this).find("video").each(function(){if(!e(this).data("controls")){let r=e(this);_("(reel) Added video html5 contorller #modify"),h.MODIFY_VIDEO_VOLUME&&(this.volume=l.videoVolume,e(this).on("loadstart",function(){this.volume=l.videoVolume})),e(this).on("contextmenu",function(c){c.preventDefault(),r.css("z-index","-1"),r.removeAttr("controls")}),e(this).parent().find('video + div div[role="button"]').filter(function(){return e(this).parent('div[role="presentation"]').length>0&&e(this).css("cursor")==="pointer"&&e(this).attr("style")!=null}).first().on("contextmenu",function(c){c.preventDefault(),r.css("z-index","2"),r.attr("controls",!0)}),e(this).on("volumechange",function(){let c=e(this).parent().find("video + div > div").find('button[type="button"], div[role="button"]').filter(function(p){return e(this).width()<=64&&e(this).height()<=64&&e(this).find('svg > path[d^="M16.636 7.028a1.5"], svg > path[d^="M1.5 13.3c-.8"]').length>0});var I=c.find('svg > path[d^="M16.636"]').length===0;this.muted!=I&&(this.volume=l.videoVolume,c?.trigger("click")),e(this).attr("data-completed")&&(l.videoVolume=this.volume,GM_setValue("G_VIDEO_VOLUME",this.volume)),this.volume==l.videoVolume&&e(this).attr("data-completed",!0)}),e(this).css("position","absolute"),e(this).css("z-index","2"),e(this).attr("data-controls",!0),e(this).attr("controls",!0)}});var s=t.find("video"),d=e(this).find('div[role="presentation"] > div[role="button"] > div').first();q(s,d,"reel")}}))},250)}catch(t){console.error("[reels]",t)}}async function Pe(n,a){try{e(".IG_POPUP_DIG #post_info").text(`${a} ID: ${n.data.reels_media[0].id}`);const o=".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY";n.data.reels_media[0].items.forEach((i,t)=>{let s=new Date().getTime(),d=Math.floor(s/1e3),r=n.data.reels_media[0]?.user?.username||n.data.reels_media[0]?.owner?.username;h.RENAME_PUBLISH_DATE&&(d=i.taken_at_timestamp),i.display_resources.sort(function(c,I){return c.config_width<I.config_width?1:c.config_width>I.config_width?-1:0}),i.is_video?e(o).append(`<a media-id="${i.id}" datetime="${d}" data-blob="true" data-needed="direct" data-name="${a}" data-type="mp4" data-username="${r}" data-path="${i.id}" data-globalIndex="${t+1}" href="javascript:;" data-href="${i.video_resources[0].src}"><img width="100" src="${i.display_resources[0].src}" /><br/>- <span data-ih-locale-title="VID">${u("VID")}</span> ${t} -</a>`):e(o).append(`<a media-id="${i.id}" datetime="${d}" data-blob="true" data-needed="direct" data-name="${a}" data-type="jpg" data-username="${r}" data-path="${i.id}" data-globalIndex="${t+1}" href="javascript:;" data-href="${i.display_resources[0].src}"><img width="100" src="${i.display_resources[0].src}" /><br/>- <span data-ih-locale-title="IMG">${u("IMG")}</span> ${t} -</a>`)}),e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY a").each(function(){e(this).wrap("<div></div>"),e(this).before('<label class="inner_box_wrapper"><input class="inner_box" type="checkbox"><span></span></label>'),e(this).after(`<div data-ih-locale-title="NEW_TAB" title="${u("NEW_TAB")}" class="newTab">${O.NEW_TAB}</div>`),e(this).attr("data-type")=="mp4"&&e(this).after(`<div data-ih-locale-title="VIDEO_THUMBNAIL" title="${u("VIDEO_THUMBNAIL")}" class="videoThumbnail">${O.THUMBNAIL}</div>`)}),E(!1)}catch(o){console.error("createStoryListDOM()",o)}}async function Se(){E(!0);let n=new Date().getTime(),a=Math.floor(n/1e3),o=e("body > div section._ac0a header._ac0k ._ac0l a + div a").first().text()||location.pathname.split("/").filter(d=>d.length>0).at(1),t=(await k(o)).user.pk,s=await j(t);if(h.DIRECT_DOWNLOAD_STORY){let d=0;Y(d,s.data.reels_media[0].items.length),s.data.reels_media[0].items.forEach((r,c)=>{setTimeout(()=>{h.RENAME_PUBLISH_DATE&&(a=r.taken_at_timestamp),r.display_resources.sort(function(I,p){return I.config_width<p.config_width?1:I.config_width>p.config_width?-1:0}),r.is_video?A(r.video_resources[0].src,o,"stories",a,"mp4",r.id).then(()=>{Y(++d,s.data.reels_media[0].items.length)}):A(r.display_resources[0].src,o,"stories",a,"jpg",r.id).then(()=>{Y(++d,s.data.reels_media[0].items.length)})},100*c)})}else S(!1,!0),Pe(s,"stories")}async function V(n,a,o){var i=e("body > div section._ac0a header._ac0k ._ac0l a + div a").first().text()||location.pathname.split("/").filter(t=>t.length>0).at(1);if(n){let t=new Date().getTime(),s=Math.floor(t/1e3);if(E(!0),h.FORCE_RESOURCE_VIA_MEDIA&&!l.tempFetchRateLimit){let d=null,c=(await k(i)).user.pk,I=await j(c),p=location.pathname.split("/").filter(g=>g.length>0&&g.match(/^([0-9]{10,})$/)).at(-1);if(I.data.reels_media[0].items.forEach(g=>{g.id==p&&(d=g.id)}),d==null&&F(i).each(function(m){e(this).children().length>0&&(d=I.data.reels_media[0].items[m].id)}),d==null&&(e("body > div section:visible div.x1ned7t2.x78zum5 > div").each(function(g){e(this).hasClass("x1lix1fw")&&e(this).children().length>0&&(d=I.data.reels_media[0].items[g].id)}),e("body > div section:visible ._ac0k > ._ac3r > div").each(function(g){e(this).children().hasClass("_ac3q")&&(d=I.data.reels_media[0].items[g].id)})),d==null&&(d=location.pathname.split("/").filter(g=>g.length>0&&g.match(/^([0-9]{10,})$/)).at(-1)),h.CAPTURE_IMAGE_VIA_MEDIA_CACHE){const g=X(d);if(g&&!I.data.reels_media[0].items.filter(m=>m.id===d).at(0).is_video){_("[Restore Cached onStory]",d),o?w(g):A(g,i,"stories",s,"jpg",d);return}}let f=await z(d);h.RENAME_PUBLISH_DATE&&(s=f.items[0].taken_at),f.status==="ok"?f.items[0].video_versions?o?w(f.items[0].video_versions[0].url):A(f.items[0].video_versions[0].url,i,"stories",s,"mp4",d):o?w(f.items[0].image_versions2.candidates[0].url):A(f.items[0].image_versions2.candidates[0].url,i,"stories",s,"jpg",d):(h.FALLBACK_TO_BLOB_FETCH_IF_MEDIA_API_THROTTLED?(l.tempFetchRateLimit=!0,V(n,a,o)):alert("Fetch failed from Media API. API response message: "+f.message),_(f)),E(!1);return}if(e("body > div section:visible video[playsinline]").length>0){let d="mp4",r="",c=location.pathname.replace(/\/$/ig,"").split("/").at(-1),I=null;if(l.GL_dataCache.stories[i]&&!a){if(_("Fetch from memory cache:",i),l.GL_dataCache.stories[i].data.reels_media[0].items.forEach(p=>{p.id==c&&(r=p.video_resources[0].src,h.RENAME_PUBLISH_DATE&&(s=p.taken_at_timestamp,I=p.id))}),r.length==0){_("Memory cache not found, try fetch from API:",i),V(!0,!0);return}}else{let f=(await k(i)).user.pk,g=await j(f);g.data.reels_media[0].items.forEach(m=>{m.id==c&&(r=m.video_resources[0].src,h.RENAME_PUBLISH_DATE&&(s=m.taken_at_timestamp,I=m.id))}),r.length==0&&(F(i).each(function(v){e(this).children().length>0&&(r=g.data.reels_media[0].items[v].video_resources[0].src,h.RENAME_PUBLISH_DATE&&(s=g.data.reels_media[0].items[v].taken_at_timestamp,I=g.data.reels_media[0].items[v].id))}),r.length==0&&(e("body > div section:visible div.x1ned7t2.x78zum5 > div").each(function(v){e(this).hasClass("x1lix1fw")&&e(this).children().length>0&&(r=g.data.reels_media[0].items[v].video_resources[0].src,h.RENAME_PUBLISH_DATE&&(s=g.data.reels_media[0].items[v].taken_at_timestamp,I=g.data.reels_media[0].items[v].id))}),e("body > div section:visible ._ac0k > ._ac3r > div").each(function(v){e(this).children().hasClass("_ac3q")&&(r=g.data.reels_media[0].items[v].video_resources[0].src,h.RENAME_PUBLISH_DATE&&(s=g.data.reels_media[0].items[v].taken_at_timestamp,I=g.data.reels_media[0].items[v].id))}))),l.GL_dataCache.stories[i]=g}r.length==0?alert(u("NO_VID_URL")):o?w(r):A(r,i,"stories",s,d,I)}else{let d=e("body > div section:visible img[referrerpolicy][class], body > div section:visible img[crossorigin][class]:not([alt])").attr("srcset")?.split(",")[0]?.split(" ")[0],r=d||e("body > div section:visible img[referrerpolicy][class], body > div section:visible img[crossorigin][class]:not([alt])").filter(function(){return e(this).parents("a").length===0&&e(this).width()===e(this).parent().width()}).attr("src");if(!r){let f=e("body > div section:visible img._aa63");r=f.attr("srcset")?f.attr("srcset")?.split(",")[0]?.split(" ")[0]:f.attr("src")}h.RENAME_PUBLISH_DATE&&(s=new Date(e("body > div section:visible time[datetime][class]").first().attr("datetime")).getTime());let c=r,I="jpg";const p=X(Ve(c)??"-");if(h.CAPTURE_IMAGE_VIA_MEDIA_CACHE){const f=X(p);if(f){o?w(f):A(f,i,"stories",s,"jpg",p);return}}o?w(c):A(c,i,"stories",s,I,p)}l.tempFetchRateLimit=!1,E(!1)}else if(!e(".IG_DWSTORY").length){l.GL_dataCache.stories={};let t=null;if(e("body > div section._ac0a").length>0?t=e("body > div section:visible._ac0a"):(t=e("body > div section:visible > div > div[style]:not([class])"),t.css("position","relative")),t.length===0&&(t=e('div[id^="mount"] section > div > a[href="/"]').parent().parent().parent().find("section:visible > div > div[style]:not([class])"),t.css("position","relative")),t.length===0&&(t=e('div[id^="mount"] section > div > a[href="/"]').parent().parent().parent().find('section:visible > div div[style]:not([class]) > div:not([data-visualcompletion="loading-state"])'),t.css("position","relative")),t.length===0){let s=e("body > div div:not([hidden]) section:visible > div div[class][style] > div[style]:not([class])"),d=0;s.each(function(){e(this).width()>d&&(d=e(this).width(),t=e(this).children("div").first())})}t!=null&&(t.first().css("position","relative"),t.first().append(`<div data-ih-locale-title="DW" title="${u("DW")}" class="IG_DWSTORY">${O.DOWNLOAD}</div>`),t.first().append(`<div data-ih-locale-title="NEW_TAB" title="${u("NEW_TAB")}" class="IG_DWNEWTAB">${O.NEW_TAB}</div>`),F(i).length>1&&t.first().append(`<div data-ih-locale-title="DW_ALL" title="${u("DW_ALL")}" class="IG_DWSTORY_ALL">${O.DOWNLOAD_ALL}</div>`),t.find("img[referrerpolicy]").each(function(){e(this).on("load",function(){e(this).data("remove-thumbnail")||(t.find(".IG_DWSTORY_THUMBNAIL").length===0?(e(this).attr("data-remove-thumbnail",!0),e(".IG_DWSTORY_THUMBNAIL").remove(),_("(story) Manually removing thumbnail button")):(e(this).attr("data-remove-thumbnail",!0),_("(story) Thumbnail button is not present for this picture")))})}))}}async function ee(n,a){if(n){let o=new Date().getTime(),i=Math.floor(o/1e3),t="jpg",s=e("body > div section._ac0a header._ac0k ._ac0l a + div a").first().text()||location.pathname.split("/").at(2),d=location.pathname.replace(/\/$/ig,"").split("/").at(-1),r="",c=null;if(E(!0),h.FORCE_RESOURCE_VIA_MEDIA&&!l.tempFetchRateLimit){let p=(await k(s)).user.pk,f=await j(p),g=location.pathname.split("/").filter(v=>v.length>0&&v.match(/^([0-9]{10,})$/)).at(-1);f.data.reels_media[0].items.forEach(v=>{v.id==g&&(c=v.id)}),c==null&&F(s).each(function(P){e(this).children().length>0&&(c=f.data.reels_media[0].items[P].id)}),c==null&&(e("body > div section:visible div.x1ned7t2.x78zum5 > div").each(function(v){e(this).hasClass("x1lix1fw")&&e(this).children().length>0&&(c=f.data.reels_media[0].items[v].id)}),e("body > div section:visible ._ac0k > ._ac3r > div").each(function(v){e(this).children().hasClass("_ac3q")&&(c=f.data.reels_media[0].items[v].id)})),c==null&&(c=location.pathname.split("/").filter(v=>v.length>0&&v.match(/^([0-9]{10,})$/)).at(-1));let m=await z(c);h.RENAME_PUBLISH_DATE&&(i=m.items[0].taken_at),m.status==="ok"?A(m.items[0].image_versions2.candidates[0].url,s,"stories",i,"jpg",c):(h.FALLBACK_TO_BLOB_FETCH_IF_MEDIA_API_THROTTLED?(l.tempFetchRateLimit=!0,ee(!0,a)):alert("Fetch failed from Media API. API response message: "+m.message),_(m)),E(!1);return}if(l.GL_dataCache.stories[s]&&!a){if(_("Fetch from memory cache:",s),l.GL_dataCache.stories[s].data.reels_media[0].items.forEach(I=>{I.id==d&&(r=I.display_url,h.RENAME_PUBLISH_DATE&&(i=I.taken_at_timestamp,c=I.id))}),r.length==0){_("Memory cache not found, try fetch from API:",s),ee(!0,!0);return}}else{let p=(await k(s)).user.pk,f=await j(p);f.data.reels_media[0].items.forEach(g=>{g.id==d&&(r=g.display_url,h.RENAME_PUBLISH_DATE&&(i=g.taken_at_timestamp,c=g.id))}),r.length==0&&(F(s).each(function(m){e(this).children().length>0&&(r=f.data.reels_media[0].items[m].display_url,h.RENAME_PUBLISH_DATE&&(i=f.data.reels_media[0].items[m].taken_at_timestamp,c=f.data.reels_media[0].items[m].id))}),r.length==0&&(e("body > div section:visible div.x1ned7t2.x78zum5 > div").each(function(m){e(this).hasClass("x1lix1fw")&&e(this).children().length>0&&(r=f.data.reels_media[0].items[m].display_url,h.RENAME_PUBLISH_DATE&&(i=f.data.reels_media[0].items[m].taken_at_timestamp,c=f.data.reels_media[0].items[m].id))}),e("body > div section:visible ._ac0k > ._ac3r > div").each(function(m){e(this).children().hasClass("_ac3q")&&(r=f.data.reels_media[0].items[m].display_url,h.RENAME_PUBLISH_DATE&&(i=f.data.reels_media[0].items[m].taken_at_timestamp,c=f.data.reels_media[0].items[m].id))})))}A(r,s,"thumbnail",i,t,c),l.tempFetchRateLimit=!1,E(!1)}else if(e("body > div div.IG_DWSTORY").parent().find("video[class]").length){let o=null;if(e("body > div section._ac0a").length>0?o=e("body > div section:visible._ac0a"):(o=e("body > div section:visible > div > div[style]:not([class])"),o.css("position","relative")),o.length===0&&(o=e('div[id^="mount"] section > div > a[href="/"]').parent().parent().parent().find("section:visible > div > div[style]:not([class])"),o.css("position","relative")),o.length===0&&(o=e('div[id^="mount"] section > div > a[href="/"]').parent().parent().parent().find('section:visible > div div[style]:not([class]) > div:not([data-visualcompletion="loading-state"])'),o.css("position","relative")),o.length===0){let i=e("body > div div:not([hidden]) section:visible > div div[class][style] > div[style]:not([class])"),t=0;i.each(function(){e(this).width()>t&&(t=e(this).width(),o=e(this).children("div").first())})}o!=null&&(o.first().css("position","relative"),o.first().append(`<div data-ih-locale-title="VIDEO_THUMBNAIL" title="${u("VIDEO_THUMBNAIL")}" class="IG_DWSTORY_THUMBNAIL">${O.THUMBNAIL}</div>`))}}function oe(n){return new Promise((a,o)=>{let i=`https://www.instagram.com/graphql/query/?query_hash=45246d3fe16ccc6577e0bd297a5db1ab&variables=%7B%22highlight_reel_ids%22:%5B%22${n}%22%5D,%22precomposed_overlay%22:false%7D`;GM_xmlhttpRequest({method:"GET",url:i,onload:function(t){try{let s=JSON.parse(t.response);a(s)}catch(s){_("getHighlightStories()","reject",s.message),o(s)}},onerror:function(t){_("getHighlightStories()","reject",t),o(t)}})})}function j(n){return new Promise((a,o)=>{let i=`https://www.instagram.com/graphql/query/?query_hash=15463e8449a83d3d60b06be7e90627c7&variables=%7B%22reel_ids%22:%5B%22${n}%22%5D,%22precomposed_overlay%22:false%7D`;GM_xmlhttpRequest({method:"GET",url:i,onload:function(t){try{let s=JSON.parse(t.response);_("getStories()",s),a(s)}catch(s){_("getStories()","reject",s.message),o(s)}},onerror:function(t){_("getStories()","reject",t),o(t)}})})}function k(n){return new Promise((a,o)=>{let i=`https://www.instagram.com/web/search/topsearch/?query=${n}`;GM_xmlhttpRequest({method:"GET",url:i,onload:function(t){let s=JSON.parse(t.response),d=null;s.users.forEach(r=>{r.user.username?.toLowerCase()===n?.toLowerCase()&&(d=r)}),d!=null?(_("getUserId()",d),a(d)):Be(n).then(r=>{a(r)}).catch(r=>{alert("Cannot find user info from getUserId()")})},onerror:function(t){_("getUserId()","reject",t),o(t)}})})}function Be(n){return new Promise((a,o)=>{let i=`https://i.instagram.com/api/v1/users/web_profile_info/?username=${n}`;GM_xmlhttpRequest({method:"GET",url:i,headers:{"X-IG-App-ID":te()},onload:function(t){try{let s=JSON.parse(t.response);if(s?.data?.user!=null){let r=s?.data;r.user.pk=r.user.id,_("getUserIdWithAgent()",s),a(r)}else _("getUserIdWithAgent()","reject","undefined"),o("undefined")}catch(s){_("getUserIdWithAgent()","reject",s.message),o(s)}},onerror:function(t){_("getUserIdWithAgent()","reject",t),o(t)}})})}function xe(n){return new Promise((a,o)=>{let i=`https://i.instagram.com/api/v1/users/${n}/info/`;GM_xmlhttpRequest({method:"GET",url:i,headers:{"User-Agent":"Mozilla/5.0 (Linux; Android 10; Pixel 7 XL)Build/RP1A.20845.002; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/5.0 Chrome/117.0.5938.60 Mobile Safari/537.36 Instagram 307.0.0.34.111"},onload:function(t){try{let s=JSON.parse(t.response);s.status!=="ok"?(_("getUserHighSizeProfile()","reject",s),o("faild")):(_("getUserHighSizeProfile()",s),a(s.user.hd_profile_pic_url_info?.url))}catch(s){_("getUserHighSizeProfile()","reject",s),o(s)}},onerror:function(t){_("getUserHighSizeProfile()","reject",t),o(t)}})})}function We(n){return new Promise((a,o)=>{n||o("NOPATH");let t=`https://www.instagram.com/graphql/query/?query_hash=2c4c2e343a8f64c625ba02b2aa12c7f8&variables=%7B%22shortcode%22:%22${n}%22}`;GM_xmlhttpRequest({method:"GET",url:t,onload:function(s){try{let d=JSON.parse(s.response);_("getPostOwner()",d),a(d.data.shortcode_media.owner.username)}catch(d){_("getPostOwner()","reject",d.message),o(d)}},onerror:function(s){_("getPostOwner()","reject",s),o(s)}})})}function Ee(n){return new Promise((a,o)=>{n||o("NOPATH");let i=n,t=`https://www.instagram.com/graphql/query/?query_hash=2c4c2e343a8f64c625ba02b2aa12c7f8&variables=%7B%22shortcode%22:%22${i}%22}`;GM_xmlhttpRequest({method:"GET",url:t,headers:{"User-Agent":"Mozilla/5.0 (Linux; Android 10; Pixel 7 XL)Build/RP1A.20845.002; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/5.0 Chrome/117.0.5938.60 Mobile Safari/537.36 Instagram 307.0.0.34.111"},onload:function(s){try{let d=JSON.parse(s.response);_(d),d.status==="fail"?(_("Request with:","getBlobMediaWithQuery()",i),He(i).then(r=>{a({type:"query_id",data:r.xdt_api__v1__media__shortcode__web_info.items[0]})}).catch(r=>{o(r)})):a({type:"query_hash",data:d.data})}catch(d){_("getBlobMedia()","reject",d.message),o(d)}},onerror:function(s){_("getBlobMedia()","reject",s),o(s)}})})}function He(n){return new Promise((a,o)=>{n||o("NOPATH");let t=`https://www.instagram.com/graphql/query/?query_id=9496392173716084&variables={%22shortcode%22:%22${n}%22,%22__relay_internal__pv__PolarisFeedShareMenurelayprovider%22:true,%22__relay_internal__pv__PolarisIsLoggedInrelayprovider%22:true}`;GM_xmlhttpRequest({method:"GET",url:t,headers:{"User-Agent":"Mozilla/5.0 (Linux; Android 10; Pixel 7 XL)Build/RP1A.20845.002; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/5.0 Chrome/117.0.5938.60 Mobile Safari/537.36 Instagram 307.0.0.34.111","X-IG-App-ID":te()},onload:function(s){try{let d=JSON.parse(s.response);_(d),d.status==="fail"?(alert(`getBlobMediaWithQueryID(): Request failed with API response:
${d.message}: ${d.feedback_message}`),_(`Request failed with API response ${d.message}: ${d.feedback_message}`),o(s)):(_("getBlobMediaWithQueryID()",d.data),a(d.data))}catch(d){_("getBlobMediaWithQueryID()","reject",d.message),o(d)}},onerror:function(s){_("getBlobMediaWithQueryID()","reject",s),o(s)}})})}function z(n){return new Promise((a,o)=>{let i=`https://i.instagram.com/api/v1/media/${n}/info/`;if(n==null){alert("Cannot call Media API because of the media id is invalid."),_("getMediaInfo()","reject","Cannot call Media API because of the media id is invalid."),E(!1),o(-1);return}if(te()==null){alert("Cannot call Media API because of the app id is invalid."),_("getMediaInfo()","reject","Cannot call Media API because of the app id is invalid."),E(!1),o(-1);return}GM_xmlhttpRequest({method:"GET",url:i,headers:{"User-Agent":window.navigator.userAgent,Accept:"*/*","X-IG-App-ID":te()},onload:function(t){if(t.finalUrl==i){let s=JSON.parse(t.response);_("getMediaInfo()",s),a(s)}else new URL(t.finalUrl).pathname.startsWith("/accounts/login")?(_("getMediaInfo()","reject","The account must be logged in to access Media API."),alert("The account must be logged in to access Media API.")):(_("getMediaInfo()","reject",'Unable to retrieve content because the API was redirected to "'+t.finalUrl+'"'),alert('Unable to retrieve content because the API was redirected to "'+t.finalUrl+'"')),E(!1),o(-1)},onerror:function(t){_("getMediaInfo()","reject",t),a(t)}})})}function Ve(n){let o=new URL(n)?.searchParams?.get("ig_cache_key")?.split(".").at(0);return o?atob(o):null}function te(){let n=null;return e('script[type="application/json"]').each(function(){const a=/"APP_ID":"([0-9]+)"/ig;e(this).text().match(a)!=null&&n==null&&(n=[...e(this).text().matchAll(a)])}),n?n.at(0).at(-1):null}function E(n){n?(e('div[id^="mount"] > div > div > div:first').removeClass("x1s85apg"),e('div[id^="mount"] > div > div > div:first').css("z-index","20000")):(e('div[id^="mount"] > div > div > div:first').addClass("x1s85apg"),e('div[id^="mount"] > div > div > div:first').css("z-index",""))}function F(n){let a=e('body > div section:visible a[href^="/'+n+'"] span').filter(function(){return e(this).children().length===0&&e(this).find("svg").length===0&&e(this).text()?.toLowerCase()===n?.toLowerCase()}).parents("div:not([class]):not([style])").filter(function(){return e(this).text()?.toLowerCase()!==n?.toLowerCase()}).filter(function(){return e(this).children().length>1}).first();return a.length===0&&(a=e('body > div section:visible a[href^="/'+n+'"]').filter(function(){return e(this).find("img").length>0}).parents("div:not([class]):not([style])").filter(function(){return e(this).text()?.toLowerCase()!==n?.toLowerCase()}).filter(function(){return e(this).children().length>1}).first()),a.children().filter(function(){return e(this).height()<10}).first().children()}function Y(n,a){e(".circle_wrapper").length?(e(".circle_wrapper span").text(`${n}/${a}`),n>=a&&e(".circle_wrapper").fadeOut(250,function(){e(this).remove()})):e("body").append(`<div class="circle_wrapper"><circle></circle><span>${n}/${a}</span></div>`)}function S(n,a){let o=n?"hidden":"";e("body").append('<div class="IG_POPUP_DIG '+o+'"><div class="IG_POPUP_DIG_BG"></div><div class="IG_POPUP_DIG_MAIN"><div class="IG_POPUP_DIG_TITLE"></div><div class="IG_POPUP_DIG_BODY"></div></div></div>'),e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_TITLE").append(`<div style="position:relative;min-height:36px;text-align:center;margin-bottom: 7px;"><div style="position:absolute;left:0px;line-height: 18px;"><kbd>Alt</kbd>+<kbd>Q</kbd> [<span data-ih-locale="CLOSE">${u("CLOSE")}</span>]</div><div style="line-height: 18px;">IG Helper v${GM_info.script.version}</div><div id="post_info" style="line-height: 14px;font-size:14px;">Post ID: <span id="article-id"></span></div><div class="IG_POPUP_DIG_BTN">${O.CLOSE}</div></div>`),a&&(e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_TITLE").append('<div style="text-align: center;" id="button_group"></div>'),e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_TITLE > div#button_group").append(`<button id="batch_download_selected" data-ih-locale="BATCH_DOWNLOAD_SELECTED">${u("BATCH_DOWNLOAD_SELECTED")}</button>`),e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_TITLE > div#button_group").append(`<button id="batch_download_direct" data-ih-locale="BATCH_DOWNLOAD_DIRECT">${u("BATCH_DOWNLOAD_DIRECT")}</button>`),e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_TITLE").append(`<label class="checkbox"><input value="yes" type="checkbox" /><span data-ih-locale="ALL_CHECK">${u("ALL_CHECK")}</span></label>`))}function ke(n){e(".IG_POPUP_DIG").length&&(n?e(".IG_POPUP_DIG").addClass("hidden"):e(".IG_POPUP_DIG").removeClass("hidden"))}function A(n,a,o,i,t,s){return new Promise(d=>{setTimeout(()=>{E(!0),fetch(n).then(r=>r.blob().then(c=>{E(!1),Fe(n,c,a,o,i,t,s),d(!0)}))},50)})}function le(n,a){const o=document.createElement("a");o.href=URL.createObjectURL(n),o.download=a,o.click(),o.remove()}function Fe(n,a,o,i,t,s,d){t=parseInt(t.toString().padEnd(13,"0")),h.RENAME_PUBLISH_DATE&&(t=parseInt(t.toString().padEnd(13,"0")));const r=new Date(t),c=new URL(n).pathname.split("/").at(-1).split(".").slice(0,-1).join("."),I=r.getFullYear().toString(),p=(r.getMonth()+1).toString().padStart(2,"0"),f=r.getDate().toString().padStart(2,"0"),g=r.getHours().toString().padStart(2,"0"),m=r.getMinutes().toString().padStart(2,"0"),v=r.getSeconds().toString().padStart(2,"0");var P=l.fileRenameFormat.toUpperCase(),U=d??"",R={"%USERNAME%":o,"%SOURCE_TYPE%":i,"%SHORTCODE%":U,"%YEAR%":I,"%2-YEAR%":I.substr(-2),"%MONTH%":p,"%DAY%":f,"%HOUR%":g,"%MINUTE%":m,"%SECOND%":v,"%ORIGINAL_NAME%":c,"%ORIGINAL_NAME_FIRST%":c.split("_").at(0)};P=P.replace(/%[\w\-]+%/g,function(T){return R[T]||T});const G=o+"_"+c+"."+s,L=h.AUTO_RENAME?P+"."+s:G;h.MODIFY_RESOURCE_EXIF&&s==="jpg"&&d&&i==="photo"&&(a.type==="image/jpeg"||a.type==="image/webp")?Ye(a,d).then(T=>le(T,L)).catch(T=>{console.error("Failed to strip EXIF and/or attach post URL to EXIF.",T),le(a,L)}):le(a,L)}async function Ye(n,a){const o=(...b)=>{const M=b.reduce((W,B)=>W+B.length,0),C=new Uint8Array(M);let y=0;for(const W of b)C.set(W,y),y+=W.length;return C},i=b=>{const M=new Uint8Array(4);return new DataView(M.buffer).setUint32(0,b,!0),M},t=b=>new TextEncoder().encode(b),s=(b,M)=>String.fromCharCode(b.getUint8(M),b.getUint8(M+1),b.getUint8(M+2),b.getUint8(M+3)),d=new Uint8Array(await n.slice(0,12).arrayBuffer()),r=d[0]===255&&d[1]===216,c=d.length>=12&&String.fromCharCode(...d.subarray(0,4))==="RIFF"&&String.fromCharCode(...d.subarray(8,12))==="WEBP";if(!r&&!c)throw new Error("Not a JPEG or WEBP");const I=t(`https://www.instagram.com/p/${a}/\0`),p=t("Exif\0\0"),f=Uint8Array.from([73,73,42,0,8,0,0,0]),g=Uint8Array.from([1,0]),m=o(Uint8Array.from([14,1,2,0]),i(I.length),i(26)),v=o(f,g,m,i(0),I);if(r){const b=await n.arrayBuffer(),M=new DataView(b),C=o(p,v),y=new Uint8Array(4);new DataView(y.buffer).setUint16(0,65505),new DataView(y.buffer).setUint16(2,C.length+2);const W=o(y,C),B=[new Uint8Array(b,0,2)];let x=2,et=!1;for(;x<M.byteLength;){const H=M.getUint16(x);if((H&65280)!==65280)break;if(H===65498){et||B.push(W),B.push(new Uint8Array(b,x));break}const J=M.getUint16(x+2)+2;if(H===65505){x+=J;continue}B.push(new Uint8Array(b,x,J)),x+=J}const tt=B.reduce((H,J)=>H+J.length,0),Ue=new Uint8Array(tt);let Me=0;return B.forEach(H=>{Ue.set(H,Me),Me+=H.length}),new Blob([Ue],{type:"image/jpeg"})}const P=await n.arrayBuffer(),U=new DataView(P),R=[];let G=-1,L=12;for(;L<U.byteLength;){const b=s(U,L),M=U.getUint32(L+4,!0),C=M&1,y=8+M+C;b!=="EXIF"&&b!=="XMP "&&(R.push(new Uint8Array(P,L,y)),b==="VP8X"&&(G=R.length-1)),L+=y}let T=o(t("EXIF"),i(p.length+v.length),p,v);if(T.length&1&&(T=o(T,Uint8Array.of(0))),G!==-1){const b=new Uint8Array(R[G]);b[8]|=16,R[G]=b,R.splice(G+1,0,T)}else R.push(T);const D=R.reduce((b,M)=>b+M.length,0),ie=o(t("RIFF"),i(D+4),t("WEBP")),ae=o(ie,...R);return new Blob([ae],{type:"image/webp"})}async function de(n,a){let o=new Date().getTime(),i=Math.floor(o/1e3),t=e(n).attr("data-username")?e(n).attr("data-username"):l.GL_username;!t&&e(n).attr("data-path")&&(_("catching owner name from shortcode:",e(n).attr("data-href")),t=await We(e(n).attr("data-path")).catch(r=>{_("get username failed, replace with default string, error message:",r.message)}),t==null&&(t="NONE")),h.RENAME_PUBLISH_DATE&&e(n).attr("datetime")&&(i=parseInt(e(n).attr("datetime")));let s=e(n).attr("media-id");if(h.CAPTURE_IMAGE_VIA_MEDIA_CACHE){const r=X(s);if(r&&e(n).data("type")!="mp4"){a?w(r):A(r,t,e(n).data("name"),i,e(n).data("type")||"jpg",e(n).data("path"));return}}if(h.FORCE_RESOURCE_VIA_MEDIA){E(!0);let r=await z(e(n).attr("media-id"));if(E(!1),r.status==="ok"){var d=null;if(r.items[0].video_versions)d=r.items[0].video_versions[0].url;else{r.items[0].image_versions2.candidates.sort(function(p,f){let g=new URL(p.url).searchParams.get("stp"),m=new URL(f.url).searchParams.get("stp");if(g&&m){if(g.length>m.length)return 1;if(g.length<m.length)return-1}else{if(p.width<f.width)return 1;if(p.width>f.width)return-1}return 0}),d=r.items[0].image_versions2.candidates[0].url;const I=function(p){if(p.width!=null)return p.width;const g=new URL(p.url).searchParams.get("stp");return g!=null?parseInt(g.match(/_p([0-9]+)x([0-9]+)_/i)?.at(1)||-1):0}(r.items[0].image_versions2.candidates[0]);r.items[0].original_width}if(a){let c=new URL(d);c.host="scontent.cdninstagram.com",w(c.href)}else A(d,t,e(n).attr("data-name"),i,e(n).attr("data-type"),e(n).attr("data-path"))}else{if(h.FALLBACK_TO_BLOB_FETCH_IF_MEDIA_API_THROTTLED)if(a){let c=new URL(e(n).attr("data-href"));c.host="scontent.cdninstagram.com",w(c.href)}else A(e(n).attr("data-href"),t,e(n).attr("data-name"),i,e(n).attr("data-type"),e(n).attr("data-path"));else alert("Fetch failed from Media API. API response message: "+r.message);_(r)}}else A(e(n).attr("data-href"),t,e(n).attr("data-name"),i,e(n).attr("data-type"),e(n).attr("data-path"))}function K(){for(let n of l.registerMenuIds)_("GM_unregisterMenuCommand",n),GM_unregisterMenuCommand(n);l.registerMenuIds.push(GM_registerMenuCommand(u("SETTING"),()=>{Ae()},{accessKey:"w"})),l.registerMenuIds.push(GM_registerMenuCommand(u("DONATE"),()=>{GM_openInTab("https://ko-fi.com/snkoarashi",{active:!0})},{accessKey:"d"})),l.registerMenuIds.push(GM_registerMenuCommand(u("DEBUG"),()=>{Le()},{accessKey:"z"})),l.registerMenuIds.push(GM_registerMenuCommand(u("FEEDBACK"),()=>{ze()},{accessKey:"f"})),l.registerMenuIds.push(GM_registerMenuCommand(u("CHECK_FOR_UPDATE"),()=>{Ge()},{accessKey:"c"})),l.registerMenuIds.push(GM_registerMenuCommand(u("RELOAD_SCRIPT"),()=>{Te()},{accessKey:"r"}))}function ce(n){if(!h.CHECK_FOR_UPDATE)return;const a=GM_getValue("G_CHECK_TIMESTAMP")??new Date().getTime();new Date().getTime()>parseInt(a)+n*1e3&&(GM_setValue("G_CHECK_TIMESTAMP",new Date().getTime()),Ge())}function Ge(){const n=GM_info.script.version;GM_xmlhttpRequest({method:"GET",url:"https://raw.githubusercontent.com/SN-Koarashi/ig-helper/refs/heads/master/main.js",onload:function(o){const t=o.responseText.match(/\/\/\s+@version\s+([0-9.\-a-zA-Z]+)/i);if(t&&t[1]){const s=t[1];_("Current version: ",n,"|","Remote version: ",s),s!==n?GM_notification({text:u("NOTICE_UPDATE_CONTENT"),title:u("NOTICE_UPDATE_TITLE"),tag:"ig_helper_notice",highlight:!0,timeout:5e3,zombieTimeout:5e3,image:"https://upload.wikimedia.org/wikipedia/commons/thumb/a/a5/Instagram_icon.png/64px-Instagram_icon.png",onclick:d=>{d?.preventDefault();var r=GM_openInTab(GM_info.script.downloadURL);setTimeout(()=>{r.close()},250)}}):_("there is no new update")}else console.error("Could not find version in the remote script.")}})}function Ae(){e(".IG_POPUP_DIG").remove(),S(),e(".IG_POPUP_DIG #post_info").text("Preference Settings"),e(".IG_POPUP_DIG .IG_POPUP_DIG_TITLE > div").append(`
                <select id="langSelect"></select>
                <div style="font-size: 12px;">
                    Some texts are machine-translated and may be inaccurate; translation contributions are welcome on GitHub.
                </div>
            `);for(const a in me)e("#langSelect").append(`<option value="${a}" ${l.lang===a?"selected":""}>${me[a]}</option>`);const n=e(".IG_POPUP_DIG .IG_POPUP_DIG_BODY");for(const a in h)n.append(`
                <label class="globalSettings"
                       title="${u(a+"_INTRO")}"
                       data-ih-locale-title="${a+"_INTRO"}">

                    <span data-ih-locale="${a}">${u(a)}</span>
                    <input id="${a}" value="box" type="checkbox"
                           ${h[a]===!0?"checked":""}>
                    <div class="chbtn"><div class="rounds"></div></div>
                </label>`),a==="MODIFY_VIDEO_VOLUME"&&n.find(`input[id="${a}"]`).parent("label").on("contextmenu",function(o){o.preventDefault(),e(this).find("#tempWrapper").length||e(this).append('<div id="tempWrapper"></div>').children("#tempWrapper").append(`<input value="${l.videoVolume}" type="range" min="0" max="1" step="0.05" />`).append(`<input value="${l.videoVolume}" step="0.05" type="number" />`).append(`<div class="IG_POPUP_DIG_BTN">${O.CLOSE}</div>`)}),a==="AUTO_RENAME"&&n.find(`input[id="${a}"]`).parent("label").on("contextmenu",function(o){o.preventDefault(),e(this).find("#tempWrapper").length||e(this).append('<div id="tempWrapper"></div>').children("#tempWrapper").append(`<input id="date_format" value="${l.fileRenameFormat}" />`).append(`<div class="IG_POPUP_DIG_BTN">${O.CLOSE}</div>`)});e(".IG_POPUP_DIG .IG_POPUP_DIG_BODY input#CHECK_FOR_UPDATE").closest("label").prependTo(".IG_POPUP_DIG .IG_POPUP_DIG_BODY"),je()}function je(){Object.entries(we).forEach(([n,a])=>{let o=e(`.IG_POPUP_DIG .IG_POPUP_DIG_BODY input#${n}`).closest("label");a.forEach(i=>{const t=e(`.IG_POPUP_DIG .IG_POPUP_DIG_BODY input#${i}`).closest("label").detach();t.addClass("child"),o.after(t),o=t})})}function Le(){e(".IG_POPUP_DIG").remove(),S(),e(".IG_POPUP_DIG #post_info").text("IG Debug DOM Tree"),e(".IG_POPUP_DIG .IG_POPUP_DIG_BODY").append('<textarea style="font-family: monospace;width:100%;box-sizing: border-box;height:300px;background: transparent;" readonly></textarea>'),e(".IG_POPUP_DIG .IG_POPUP_DIG_BODY").append('<span style="display:block;text-align:center;">'),e(".IG_POPUP_DIG .IG_POPUP_DIG_BODY span").append(`<button style="margin: 3px;" class="IG_DISPLAY_DOM_TREE"><a>${u("SHOW_DOM_TREE")}</a></button>`),e(".IG_POPUP_DIG .IG_POPUP_DIG_BODY span").append(`<button style="margin: 3px;" class="IG_SELECT_DOM_TREE"><a>${u("SELECT_AND_COPY")}</a></button>`),e(".IG_POPUP_DIG .IG_POPUP_DIG_BODY span").append(`<button style="margin: 3px;" class="IG_DOWNLOAD_DOM_TREE"><a>${u("DOWNLOAD_DOM_TREE")}</a></button><br/>`),e(".IG_POPUP_DIG .IG_POPUP_DIG_BODY span").append(`<button style="margin: 3px;" class="IG_REPORT_GITHUB"><a href="https://github.com/SN-Koarashi/ig-helper/issues" target="_blank">${u("REPORT_GITHUB")}</a></button>`),e(".IG_POPUP_DIG .IG_POPUP_DIG_BODY span").append(`<button style="margin: 3px;" class="IG_REPORT_DISCORD"><a href="https://discord.gg/q3KT4hdq8x" target="_blank">${u("REPORT_DISCORD")}</a></button>`)}function ze(){e(".IG_POPUP_DIG").remove(),S(),e(".IG_POPUP_DIG #post_info").text("Feedback Options"),e(".IG_POPUP_DIG .IG_POPUP_DIG_BODY").append('<span style="display:block;text-align:center;">'),e(".IG_POPUP_DIG .IG_POPUP_DIG_BODY span").append(`<button style="margin: 3px;" class="IG_REPORT_FORK"><a href="https://greasyfork.org/en/scripts/404535-ig-helper/feedback" target="_blank">${u("REPORT_FORK")}</a></button>`),e(".IG_POPUP_DIG .IG_POPUP_DIG_BODY span").append(`<button style="margin: 3px;" class="IG_REPORT_GITHUB"><a href="https://github.com/SN-Koarashi/ig-helper/issues" target="_blank">${u("REPORT_GITHUB")}</a></button>`),e(".IG_POPUP_DIG .IG_POPUP_DIG_BODY span").append(`<button style="margin: 3px;" class="IG_REPORT_DISCORD"><a href="https://discord.gg/q3KT4hdq8x" target="_blank">${u("REPORT_DISCORD")}</a></button>`)}function w(n){var a=document.createElement("a");a.href=n,a.target="_blank",document.body.appendChild(a),a.click(),a.remove(),setTimeout(()=>{E(!1)},125)}function Te(){clearInterval(l.GL_repeat),l.GL_registerEventList.forEach(n=>{n.trigger.forEach(a=>{e(n.element).off("click",a)})}),l.GL_registerEventList=[],e(".button_wrapper").remove(),e(".IG_DWPROFILE, .IG_DWPROFILE, .IG_DWSTORY, .IG_DWSTORY_ALL, .IG_DWSTORY_THUMBNAIL, .IG_DWNEWTAB, .IG_DWHISTORY, .IG_DWHISTORY_ALL, .IG_DWHINEWTAB, .IG_DWHISTORY_THUMBNAIL, .IG_REELS, .IG_REELS_NEWTAB, .IG_REELS_THUMBNAIL").remove(),e("[data-snig]").removeAttr("data-snig"),l.pageLoaded=!1,l.firstStarted=!1,l.currentURL=location.href,l.GL_observer.disconnect(),_("main timer re-register completed")}function _(...n){var a=new Date;l.GL_logger.push({time:a.getTime(),content:[...n]}),l.GL_logger.length>1e3&&(l.GL_logger=[{time:a.getTime(),content:["logger sliced"]},...l.GL_logger.slice(-999)]),console.log(`[${a.toISOString()}]`,...n)}function Ke(){for(let n in h)GM_getValue(n)!=null&&typeof GM_getValue(n)=="boolean"&&(h[n]=GM_getValue(n),n==="MODIFY_VIDEO_VOLUME"&&GM_getValue(n)!==!0&&(l.videoVolume=1))}function q(n,a,o,i=""){a.find("div.volume_slider").length===0?(a.append(`<div class="volume_slider ${i}" />`),a.find("div.volume_slider").append(`<div><input type="range" max="1" min="0" step="0.05" value="${l.videoVolume}" /></div>`),a.find("div.volume_slider input").attr("style",`--ig-track-progress: ${l.videoVolume*100+"%"}`),a.find("div.volume_slider input").on("input",function(){var t=e(this).val()*100+"%";l.videoVolume=e(this).val(),GM_setValue("G_VIDEO_VOLUME",e(this).val()),e(this).attr("style",`--ig-track-progress: ${t}`),n.each(function(){_(`(${o})`,"video volume changed #slider"),this.volume=l.videoVolume})}),a.find("div.volume_slider input").on("mouseenter",function(){var t=l.videoVolume*100+"%";e(this).attr("style",`--ig-track-progress: ${t}`),e(this).val(l.videoVolume),n.each(function(){_(`(${o})`,"video volume changed #slider"),this.volume=l.videoVolume})}),a.find("div.volume_slider").on("click",function(t){t.stopPropagation(),t.preventDefault()})):a.find("div.volume_slider").remove()}var be=null;function qe(n){_e(),e("body").append(`<div id="imageViewer">
    	<div id="iv_header">
    		<div style="flex:1;">Image Viewer</div>
    		<div style="display: flex;filter: invert(1);gap: 8px;margin-right: 8px;">
                <div id="rotate_left" style="cursor: pointer;">${O.TURN_DEG}</div>
                <div id="rotate_right" style="transform: scaleX(-1);cursor: pointer;">${O.TURN_DEG}</div>
            </div>
    		<div id="iv_close">${O.CLOSE}</div>
    	</div>
        <section>
            <div id="iv_transform">
                <div id="iv_rotate">
                    <img id="iv_image" src="" />
                </div>
            </div>
        </section>
    </div>`);const a=e("#imageViewer"),o=e("#imageViewer > section"),i=e("#iv_transform"),t=e("#iv_rotate"),s=e("#iv_header"),d=e("#iv_close"),r=e("#iv_image"),c=e("#rotate_left"),I=e("#rotate_right");r.attr("src",n),a.css("display","flex"),i.css("transform-origin","0 0"),i.css("transition","transform 0.15s ease"),t.css("transform-origin","center"),t.css("transition","transform 0.15s ease"),i.css("will-change","transform"),t.css("will-change","transform");let p=0,f=1,g=0,m=0,v=!1,P=!1,U,R;var G={x:0,y:0};be=setInterval(()=>{const D={x:g,y:m};D.x!==G.x||D.y!==G.y?P=!0:P=!1,G=D},100),r.on("load",()=>{g=0,m=0,L()}),r.on("dragstart drop",D=>{D.preventDefault()}),r.on("click",D=>{D.preventDefault(),D.stopPropagation(),P||(f<=1?T(D,Math.min(Math.max(1,f+1.25),5)):(f=1,g=0,m=0),L())}),o.on("wheel",D=>{D.preventDefault(),T(D)}),a.on("wheel",D=>{D.preventDefault()}),r.on("mousedown",D=>{f!=1&&(v=!0,U=D.pageX-g,R=D.pageY-m,r.css("cursor","grabbing"))}),r.on("mouseup",()=>{f!=1&&(v=!1,r.css("cursor","grab"))}),c.on("click",function(){p-=90,L()}),I.on("click",function(){p+=90,L()}),e(document).on("mousemove.igHelper",D=>{v&&(D.preventDefault(),g=D.pageX-U,m=D.pageY-R,L())}),a.on("click",()=>{_e()}),d.on("click",()=>{_e()}),s.on("click",D=>{D.preventDefault(),D.stopPropagation()});function L(){i.css("transition",P?"none":"transform 0.15s ease"),i.css("transform",`translate(${g}px, ${m}px) scale(${f})`),t.css("transform",`rotate(${p}deg)`),f==1?r.css("cursor","zoom-in"):r.css("cursor","grabbing")}function T(D,ie){D.preventDefault();let ae=f;if(ie==null){let B=.1,x=D.originalEvent.deltaY<0?1:-1;f=Math.min(5,Math.max(1,f+x*B*f))}else f=ie;let b=o[0].getBoundingClientRect(),M=D.clientX-b.left,C=D.clientY-b.top,y=(M-g)/ae,W=(C-m)/ae;g=-y*f+M,m=-W*f+C,L()}}function _e(){clearInterval(be),e("#imageViewer").remove(),e(document).off("mousemove.igHelper")}let he=!1,fe=null;function Xe(){const n=Date.now();for(const a in l.GL_imageCache)n-l.GL_imageCache[a].ts>pe&&delete l.GL_imageCache[a];GM_setValue(ne,l.GL_imageCache)}function Je(n){try{const o=new URL(n).searchParams.get("ig_cache_key");if(!o)return null;const i=o.split(".")[0];return atob(i)}catch{return null}}function Qe(n,a){if(!n)return;const o=Object.keys(l.GL_imageCache);o.length>=ye&&(o.sort((i,t)=>l.GL_imageCache[i].ts-l.GL_imageCache[t].ts),delete l.GL_imageCache[o[0]]),he=!0,l.GL_imageCache[n]={url:a,ts:Date.now()},fe||(fe=setTimeout(()=>{he&&(GM_setValue(ne,l.GL_imageCache),he=!1),fe=null},500))}function X(n){if(!n)return null;const a=l.GL_imageCache[n];return a?Date.now()-a.ts>pe?(delete l.GL_imageCache[n],null):a.url:null}function Ze(){new PerformanceObserver(a=>{h.CAPTURE_IMAGE_VIA_MEDIA_CACHE&&a.getEntries().forEach(o=>{if(o.initiatorType==="img"){const i=o.name;if(!(i.includes("_e35")||i.includes("_e15")||i.includes(".webp?efg="))||i.match(/_[sp](\d+)x\1(?!\d)/))return;const t=Je(i);t&&!l.GL_imageCache[t]&&Qe(t,i)}})}).observe({entryTypes:["resource"]})}function $e(){var n={"en-US":{NOTICE_UPDATE_TITLE:"Wololo! New version released.",NOTICE_UPDATE_CONTENT:"IG-Helper has released a new version, click here to update.",CHECK_FOR_UPDATE:"Check for Script Updates",RELOAD_SCRIPT:"Reload Script",DONATE:"Donate",FEEDBACK:"Feedback",IMAGE_VIEWER:"Open Image In Viewer",NEW_TAB:"Open in New Tab",SHOW_DOM_TREE:"Show DOM Tree",SELECT_AND_COPY:"Select All and Copy from the Input Box",DOWNLOAD_DOM_TREE:"Download DOM Tree as a Text File",REPORT_GITHUB:"Report an Issue on GitHub",REPORT_DISCORD:"Report an Issue on Discord Support Server",REPORT_FORK:"Report an Issue on Greasy Fork",DEBUG:"Debug Window",CLOSE:"Close",ALL_CHECK:"Select All",BATCH_DOWNLOAD_SELECTED:"Download Selected Resources",BATCH_DOWNLOAD_DIRECT:"Download All Resources",IMG:"Image",VID:"Video",DW:"Download",DW_ALL:"Download All Resources",VIDEO_THUMBNAIL:"Download Video Thumbnail",LOAD_BLOB_ONE:"Loading Blob Media...",LOAD_BLOB_MULTIPLE:"Loading Blob Media and Others...",LOAD_BLOB_RELOAD:"Detecting Blob Media, reloading...",NO_CHECK_RESOURCE:"You need to select a resource to download.",NO_VID_URL:"Cannot find video URL.",SETTING:"Settings",AUTO_RENAME:"Automatically Rename Files (Right-Click to Set)",RENAME_PUBLISH_DATE:"Set Renamed File Timestamp to Resource Publish Date",RENAME_LOCATE_DATE:"Modify Renamed File Timestamp Date Format (Right-Click to Set)",DISABLE_VIDEO_LOOPING:"Disable Video Auto-looping",HTML5_VIDEO_CONTROL:"Display HTML5 Video Controller",REDIRECT_CLICK_USER_STORY_PICTURE:"Redirect When Clicking on User's Story Picture",FORCE_FETCH_ALL_RESOURCES:"Force Fetch All Resources in the Post",DIRECT_DOWNLOAD_VISIBLE_RESOURCE:"Directly Download the Visible Resources in the Post",DIRECT_DOWNLOAD_ALL:"Directly Download All Resources in the Post",DIRECT_DOWNLOAD_STORY:"Directly Download All Resources in the Story/Highlight",MODIFY_VIDEO_VOLUME:"Modify Video Volume (Right-Click to Set)",MODIFY_RESOURCE_EXIF:"Modify Resource EXIF Properties",SCROLL_BUTTON:"Enable Scroll Buttons for Reels Page",FORCE_RESOURCE_VIA_MEDIA:"Force Fetch Resource via Media API",FALLBACK_TO_BLOB_FETCH_IF_MEDIA_API_THROTTLED:"Use Alternative Methods to Download When the Media API is Not Accessible",NEW_TAB_ALWAYS_FORCE_MEDIA_IN_POST:"Always Use Media API for 'Open in New Tab' in Posts",SKIP_VIEW_STORY_CONFIRM:"Skip the Confirmation Page for Viewing a Story/Highlight",CAPTURE_IMAGE_VIA_MEDIA_CACHE:"Capture Image Resource Using Media Cache",AUTO_RENAME_INTRO:`Auto rename file to custom format:
Custom Format List: 
%USERNAME% - Username
%SOURCE_TYPE% - Download Source
%SHORTCODE% - Post Shortcode
%YEAR% - Year when downloaded/published
%2-YEAR% - Year (last two digits) when downloaded/published
%MONTH% - Month when downloaded/published
%DAY% - Day when downloaded/published
%HOUR% - Hour when downloaded/published
%MINUTE% - Minute when downloaded/published
%SECOND% - Second when downloaded/published
%ORIGINAL_NAME% - Original name of downloaded file
%ORIGINAL_NAME_FIRST% - Original name of downloaded file (first part of name)

If set to false, the file name will remain unchanged.
Example: instagram_321565527_679025940443063_4318007696887450953_n.jpg`,RENAME_PUBLISH_DATE_INTRO:`Sets the timestamp in the file rename format to the resource publish date (browser time zone).

This feature only works when [Automatically Rename Files] is set to TRUE.`,RENAME_LOCATE_DATE_INTRO:`Modify the renamed file timestamp date format to the browser's local time, and format it to your preferred regional date format.

This feature only works when [Automatically Rename Files] is set to TRUE.`,DISABLE_VIDEO_LOOPING_INTRO:"Disable video auto-looping in Reels and posts.",HTML5_VIDEO_CONTROL_INTRO:`Display the HTML5 video controller in video resource.

This will hide the custom video volume slider and replace it with the HTML5 controller. The HTML5 controller can be hidden by right-clicking on the video to reveal the original details.`,REDIRECT_CLICK_USER_STORY_PICTURE_INTRO:`Redirect to a user's profile page when right-clicking on their avatar in the story area on the homepage.
If you use the middle mouse button to click, it will open in a new tab.`,FORCE_FETCH_ALL_RESOURCES_INTRO:"Force fetching of all resources (photos and videos) in a post via the Instagram API to remove the limit of three resources per post.",DIRECT_DOWNLOAD_VISIBLE_RESOURCE_INTRO:"Directly download the current resources available in the post.",DIRECT_DOWNLOAD_ALL_INTRO:"When you click the download button, all resources in the post will be forcibly fetched and downloaded.",MODIFY_VIDEO_VOLUME_INTRO:"Modify the video playback volume in Reels and posts (right-click to open the volume setting slider).",SCROLL_BUTTON_INTRO:"Enable scroll buttons for the lower right corner of the Reels page.",FORCE_RESOURCE_VIA_MEDIA_INTRO:"The Media API will try to get the highest quality photo or video possible, but it may take longer to load.",FALLBACK_TO_BLOB_FETCH_IF_MEDIA_API_THROTTLED_INTRO:"When the Media API reaches its rate limit or cannot be used for other reasons, the Forced Fetch API will be used to download resources (the resource quality may be slightly lower).",NEW_TAB_ALWAYS_FORCE_MEDIA_IN_POST_INTRO:"The [Open in New Tab] button in posts will always use the Media API to obtain high-resolution resources.",CHECK_FOR_UPDATE_INTRO:`Check for updates when the script is triggered (check every 300 seconds).
Update notifications will be sent as desktop notifications through the browser.`,SKIP_VIEW_STORY_CONFIRM_INTRO:"Automatically skip when confirmation page is shown in story or highlight.",MODIFY_RESOURCE_EXIF_INTRO:"Modify the EXIF properties of the image resource to place the post link in it.",DIRECT_DOWNLOAD_STORY_INTRO:"When you click Download All Resources, all stories/highlights are downloaded directly, without showing the image selection dialog.",CAPTURE_IMAGE_VIA_MEDIA_CACHE_INTRO:"Use a watcher to capture any high-quality image URLs in the DOM tree into the script\u2019s storage so that they can be extracted when available and upon user input."}},a=Object.assign({},n,l.locale),o=Object.keys(a).sort().reduce((i,t)=>(i[t]=a[t],i),{});return o}async function Re(n){return new Promise((a,o)=>{GM_xmlhttpRequest({method:"GET",url:`https://raw.githubusercontent.com/SN-Koarashi/ig-helper/master/locale/translations/${n}.json`,onload:function(i){try{let t=JSON.parse(i.response);a(t)}catch(t){o(t)}},onerror:function(i){_("getTranslationText()","reject",i),o(i)}})})}function u(n){const a=$e();return a[l.lang]!=null&&a[l.lang][n]!=null?a[l.lang][n]:a["en-US"][n]}function ue(){e("[data-ih-locale]").each(function(){e(this).text(u(e(this).attr("data-ih-locale")))}),e("[data-ih-locale-title]").each(function(){e(this).attr("title",u(e(this).attr("data-ih-locale-title")))})}e(function(){function n(i){var t=[];for(var s of i)t.push({tagName:s.tagName,id:s.id,className:s.className});return t}function a(){let i=e('div[id^="mount"]')[0];var t="";l.GL_logger.forEach(s=>{var d=JSON.stringify(s.content,function(r,c){return Array.isArray(this)&&typeof c=="object"&&c instanceof jQuery?n(c):c},"	");t+=`${new Date(s.time).toISOString()}: ${d}
`}),e(".IG_POPUP_DIG .IG_POPUP_DIG_BODY textarea").text(`Logger:
`+t+`
-----

Location: `+location.pathname+`
DOM Tree with div#mount:
`+i.innerHTML)}e("body").on("click",".IG_POPUP_DIG .IG_POPUP_DIG_BODY .IG_DISPLAY_DOM_TREE",function(){a()}),e("body").on("click",".IG_POPUP_DIG .IG_POPUP_DIG_BODY .IG_SELECT_DOM_TREE",function(){e(".IG_POPUP_DIG .IG_POPUP_DIG_BODY textarea").select(),document.execCommand("copy")}),e("body").on("click",".IG_POPUP_DIG .IG_POPUP_DIG_BODY .IG_DOWNLOAD_DOM_TREE",function(){e(".IG_POPUP_DIG .IG_POPUP_DIG_BODY textarea").text().length===0&&a();var i=e(".IG_POPUP_DIG .IG_POPUP_DIG_BODY textarea").text(),t=document.createElement("a"),s=new Blob([i],{type:"text/plain"});t.href=URL.createObjectURL(s),t.download="DOMTree-"+new Date().getTime()+".txt",document.body.appendChild(t),t.click(),t.remove()}),e("body").on("click",".IG_POPUP_DIG_BTN, .IG_POPUP_DIG_BG",function(){e(this).parent("#tempWrapper").length>0?e(this).parent("#tempWrapper").fadeOut(250,function(){e(this).remove()}):e(".IG_POPUP_DIG").remove()}),e(window).on("keydown",function(i){i.which=="81"&&i.altKey&&(e(".IG_POPUP_DIG").remove(),i.preventDefault()),i.which=="87"&&i.altKey&&(Ae(),i.preventDefault()),i.which=="90"&&i.altKey&&(Le(),i.preventDefault()),i.which=="82"&&i.altKey&&(Te(),i.preventDefault()),i.which=="83"&&i.altKey&&(location.href.match(/^(https:\/\/www\.instagram\.com\/stories\/)/ig)&&e(".IG_DWSTORY").length>0&&e(".IG_DWSTORY")?.trigger("click"),location.href.match(/^(https:\/\/www\.instagram\.com\/stories\/highlights\/)/ig)&&e(".IG_DWHISTORY").length>0&&e(".IG_DWHISTORY")?.trigger("click"),i.preventDefault())}),e("body").on("change",".IG_POPUP_DIG input",function(){var i=e(this).attr("id");if(i&&h[i]!==void 0){let t=e(this).prop("checked");GM_setValue(i,t),h[i]=t,console.log("user settings",i,t)}}),e("body").on("click",".IG_POPUP_DIG .globalSettings",function(i){e(this).find("#tempWrapper").length>0&&i.preventDefault()}),e("body").on("change",".IG_POPUP_DIG #tempWrapper input:not(#date_format)",function(){let i=e(this).val();e(this).attr("type")=="range"?e(this).next().val(i):e(this).prev().val(i),i>=0&&i<=1&&(l.videoVolume=i,GM_setValue("G_VIDEO_VOLUME",i))}),e("body").on("input",".IG_POPUP_DIG #tempWrapper input:not(#date_format)",function(){if(e(this).attr("type")=="range"){let i=e(this).val();e(this).next().val(i)}else{let i=e(this).val();i>=0&&i<=1?e(this).prev().val(i):i<0?e(this).val(0):e(this).val(1)}}),e("body").on("input",".IG_POPUP_DIG #tempWrapper input#date_format",function(){GM_setValue("G_RENAME_FORMAT",e(this).val()),l.fileRenameFormat=e(this).val()}),e("body").on("click",'a[data-needed="direct"]',function(i){i.preventDefault(),de(this)}),e("body").on("click",".IG_POPUP_DIG_BODY .newTab",function(){if(h.FORCE_RESOURCE_VIA_MEDIA&&h.NEW_TAB_ALWAYS_FORCE_MEDIA_IN_POST)de(e(this).parent().children("a").first()[0],!0);else{var i=new URL(e(this).parent().children("a").attr("data-href"));i.host="scontent.cdninstagram.com",w(i.href)}}),e("body").on("click",".IG_POPUP_DIG_BODY .videoThumbnail",function(){let i=new Date().getTime();h.RENAME_PUBLISH_DATE&&e(this).parent().children("a").attr("datetime")&&(i=e(this).parent().children("a").attr("datetime"));let t=e(this).parent().children("a").attr("data-path")??e("#article-id").text();A(e(this).parent().children("a").find("img").first().attr("src"),e(this).parent().children("a").attr("data-username"),"thumbnail",i,"jpg",t)}),e("body").on("click",".IG_DWSTORY",function(){V(!0)}),e("body").on("click",".IG_DWSTORY_ALL",function(){Se()}),e("body").on("click",".IG_DWNEWTAB",function(i){i.preventDefault(),V(!0,!0,!0)}),e("body").on("click",".IG_DWSTORY_THUMBNAIL",function(){ee(!0)}),e("body").on("click",".IG_DWPROFILE",function(i){i.stopPropagation(),Oe(!0)}),e("body").on("click",".IG_DWHISTORY",function(){Q(!0)}),e("body").on("click",".IG_DWHISTORY_ALL",function(){Ne()}),e("body").on("click",".IG_DWHINEWTAB",function(i){i.preventDefault(),Q(!0,!0)}),e("body").on("click",".IG_DWHISTORY_THUMBNAIL",function(){Z(!0)}),e("body").on("click",".IG_REELS",function(){$(!0,!0)}),e("body").on("click",".IG_REELS_NEWTAB",function(){$(!0,!0,!0)}),e("body").on("click",".IG_REELS_THUMBNAIL",function(){$(!0,!1)}),e("body").on("mousedown",'button[role="menuitem"], div[role="menuitem"], ul > li[tabindex="-1"] > div[role="button"]',function(i){if((i.which===3||i.which===2)&&location.href==="https://www.instagram.com/"&&h.REDIRECT_CLICK_USER_STORY_PICTURE&&(i.preventDefault(),e(this).find("canvas._aarh, canvas + span > img").length>0)){const t="https://www.instagram.com/"+e(this).children("div").last().text();i.which===2?GM_openInTab(t):location.href=t}}),e("body").on("change",".IG_POPUP_DIG_TITLE .checkbox",function(){var i=e(this).find("input").prop("checked");e(".IG_POPUP_DIG_BODY .inner_box").each(function(){e(this).prop("checked",i)})}),e("body").on("change",".IG_POPUP_DIG_BODY .inner_box",function(){var i=e(".IG_POPUP_DIG_BODY .inner_box:checked").length,t=e(".IG_POPUP_DIG_BODY .inner_box").length;e(".IG_POPUP_DIG_TITLE .checkbox").find("input").prop("checked",i==t)}),e("body").on("click",".IG_POPUP_DIG_TITLE #batch_download_selected",function(){let i=0;e('.IG_POPUP_DIG_BODY a[data-needed="direct"]').each(function(){e(this).prev().children("input").prop("checked")&&(e(this).trigger("click"),i++)}),i==0&&alert(u("NO_CHECK_RESOURCE"))}),e("body").on("change",".IG_POPUP_DIG_TITLE #langSelect",function(){GM_setValue("UI_LANGUAGE",e(this).val()),l.lang=e(this).val(),l.lang?.startsWith("en")||l.locale[l.lang]!=null?(ue(),K()):Re(l.lang).then(i=>{l.locale[l.lang]=i,ue(),K()}).catch(i=>{console.error("getTranslationText catch error:",i)})}),e("body").on("click",".IG_POPUP_DIG_TITLE #batch_download_direct",function(){e('.IG_POPUP_DIG_BODY a[data-needed="direct"]').each(function(){e(this).trigger("click")})}),Ze(),new MutationObserver(i=>{for(const t of i)t.type==="childList"&&t.addedNodes.forEach(s=>{const d=e(s).find("video");if(location.pathname.startsWith("/stories/highlights/")&&e(s).attr("data-ih-locale-title")==null&&e(s).attr("data-visualcompletion")==null&&s.tagName==="DIV"){var r=e(s).find("time[datetime]");let c=r?.attr("title");c!=null&&r.text(c)}if(d.length>0&&(h.MODIFY_VIDEO_VOLUME&&d.each(function(){e(this).on("play playing",function(){e(this).data("modify")||(e(this).attr("data-modify",!0),this.volume=l.videoVolume,_("(audio_observer) Added video event listener #modify"))})}),location.pathname.match(/^(\/stories\/)/ig))){const c=location.pathname.match(/^(\/stories\/highlights\/)/ig)!=null,I=c?"highlight":"story";d.each(function(){e(this).on("timeupdate",function(){if(!e(this).data("modify-thumbnail")){let f=e(this);f.parents("div[style][class]").filter(function(){return e(this).width()==f.width()}).find(".IG_DWSTORY_THUMBNAIL, .IG_DWHISTORY_THUMBNAIL").length===0?(e(this).attr("data-modify-thumbnail",!0),c?Z(!1):ee(!1),_(`(${I})`,"Manually inserting thumbnail button")):(e(this).attr("data-modify-thumbnail",!0),_(`(${I})`,"Thumbnail button already inserted"))}});var p=e(this);if(h.HTML5_VIDEO_CONTROL){if(!p.data("controls")){_(`(${I})`,"Added video html5 contorller #modify"),h.MODIFY_VIDEO_VOLUME&&(this.volume=l.videoVolume,p.on("loadstart",function(){this.volume=l.videoVolume}));let f=p.parents("div").filter(function(){return e(this).attr("class")==null&&e(this).attr("style")==null}).first(),g=f.next();g.hide();let m=f.find('div[class][role="button"]');m.hide();const v=function(P){P.preventDefault(),p.css("z-index","2"),p.attr("controls",!0),m.hide(),g.hide(),q(p,p.parents("div[style][class]").filter(function(){return e(this).width()==p.width()}).first(),I,"vertical")};p.parent().find("video + div").on("contextmenu",v),m.on("contextmenu",v),g.on("contextmenu",v),p.on("contextmenu",function(P){P.preventDefault(),p.css("z-index","-1"),p.removeAttr("controls"),g.show(),m.show(),q(p,p.parents("div[style][class]").filter(function(){return e(this).width()==p.width()}).first(),I,"vertical")}),p.on("volumechange",function(){let P=f.parent().find('svg > path[d^="M1.5 13.3c-.8 0-1.5.7-1.5 1.5v18.4c0"], svg > path[d^="M16.636 7.028a1.5 1.5"]').parents('[role="button"]').first();var U=P.find('svg > path[d^="M16.636"]').length===0;this.muted!=U&&(this.volume=l.videoVolume,P?.trigger("click")),e(this).attr("data-completed")&&(l.videoVolume=this.volume,GM_setValue("G_VIDEO_VOLUME",this.volume)),this.volume==l.videoVolume&&e(this).attr("data-completed",!0)}),p.css("position","absolute"),p.css("z-index","2"),p.attr("data-controls",!0),p.attr("controls",!0)}}else q(p,p.parents("div[style][class]").filter(function(){return e(this).width()==p.width()}).first(),I,"vertical")})}})}).observe(e('div[id^="mount"]')[0],{childList:!0,subtree:!0})})})(jQuery);
