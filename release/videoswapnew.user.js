// ==UserScript==
// @name         TwitchAdSolutions (video-swap-new)
// @namespace    https://github.com/pixeltris/TwitchAdSolutions
// @version      1.42
// @updateURL https://raw.githubusercontent.com/AzimsTech/Userscripts/release/release/videoswapnew.meta.js
// @downloadURL https://raw.githubusercontent.com/AzimsTech/Userscripts/release/release/videoswapnew.user.js
// @author       pixeltris
// @match        *://*.twitch.tv/*
// @run-at       document-start
// @inject-into  page
// @grant        GM.xmlHttpRequest
// @connect      gql.twitch.tv
// ==/UserScript==
(function(){"use strict";var I=9;if(typeof unsafeWindow>"u"&&(unsafeWindow=window),typeof unsafeWindow.twitchAdSolutionsVersion<"u"&&unsafeWindow.twitchAdSolutionsVersion>=I){console.log("skipping video-swap-new as there's another script active. ourVersion:"+I+" activeVersion:"+unsafeWindow.twitchAdSolutionsVersion),unsafeWindow.twitchAdSolutionsVersion=I;return}unsafeWindow.twitchAdSolutionsVersion=I;function N(t){t.OPT_MODE_STRIP_AD_SEGMENTS=!0,t.OPT_MODE_NOTIFY_ADS_WATCHED=!0,t.OPT_MODE_NOTIFY_ADS_WATCHED_MIN_REQUESTS=!1,t.OPT_BACKUP_PLAYER_TYPE="autoplay",t.OPT_BACKUP_PLATFORM="ios",t.OPT_REGULAR_PLAYER_TYPE="site",t.OPT_ACCESS_TOKEN_PLAYER_TYPE=null,t.OPT_SHOW_AD_BANNER=!0,t.AD_SIGNIFIER="stitched-ad",t.LIVE_SIGNIFIER=",live",t.CLIENT_ID="kimne78kx3ncx6brgo4mv6wki5h1ko",t.StreamInfos=[],t.StreamInfosByUrl=[],t.CurrentChannelNameFromM3U8=null,t.gql_device_id=null,t.ClientIntegrityHeader=null,t.AuthorizationHeader=null}var R=[],W=["twitch","isVariantA"],H=[],U=["isVariantA","besuper/","${patch_url}"];function B(t){for(var r=null,e=null,a=t;a;){var n=a.toString();W.some(o=>n.includes(o))&&!H.some(o=>n.includes(o))?e!==null&&Object.setPrototypeOf(e,Object.getPrototypeOf(a)):(r===null&&(r=a),e=a),a=Object.getPrototypeOf(a)}return r}function q(t){for(var r=[],e=t;e;){var a=e.toString();U.some(n=>a.includes(n))&&r.push(e),e=Object.getPrototypeOf(e)}return r}function V(t,r){for(var e=t,a=0;a<r.length;a++)Object.setPrototypeOf(r[a],e),e=r[a];return e}function $(t){var r=t.toString();return!W.some(e=>r.includes(e))||H.some(e=>r.includes(e))||U.some(e=>r.includes(e))}function x(){var t=q(unsafeWindow.Worker),r=class extends B(unsafeWindow.Worker){constructor(n,o){var s=!1;try{s=new URL(n).origin.endsWith(".twitch.tv")}catch{}if(!s){super(n,o);return}var c=`
                    const pendingFetchRequests = new Map();
                    ${L.toString()}
                    ${j.toString()}
                    ${N.toString()}
                    ${F.toString()}
                    ${T.toString()}
                    ${_.toString()}
                    ${X.toString()}
                    ${E.toString()}
                    ${b.toString()}
                    ${G.toString()}
                    var workerString = getWasmWorkerJs('${n.replaceAll("'","%27")}');
                    declareOptions(self);
                    self.addEventListener('message', function(e) {
                        if (e.data.key == 'UboUpdateDeviceId') {
                            gql_device_id = e.data.value;
                        } else if (e.data.key == 'UpdateClientIntegrityHeader') {
                            ClientIntegrityHeader = e.data.value;
                        } else if (e.data.key == 'UpdateAuthorizationHeader') {
                            AuthorizationHeader = e.data.value;
                        } else if (e.data.key == 'FetchResponse') {
                            const responseData = e.data.value;
                            if (pendingFetchRequests.has(responseData.id)) {
                                const { resolve, reject } = pendingFetchRequests.get(responseData.id);
                                pendingFetchRequests.delete(responseData.id);
                                if (responseData.error) {
                                    reject(new Error(responseData.error));
                                } else {
                                    // Create a Response object from the response data
                                    const response = new Response(responseData.body, {
                                        status: responseData.status,
                                        statusText: responseData.statusText,
                                        headers: responseData.headers
                                    });
                                    resolve(response);
                                }
                            }
                        }
                    });
                    hookWorkerFetch();
                    eval(workerString);
                `;super(URL.createObjectURL(new Blob([c])),o),R.push(this),this.addEventListener("message",l=>{if(l.data.key=="UboShowAdBanner"){var i=d();i!=null&&(i.P.textContent="Blocking"+(l.data.isMidroll?" midroll":"")+" ads",OPT_SHOW_AD_BANNER&&(i.style.display="block"))}else if(l.data.key=="UboHideAdBanner"){var i=d();i!=null&&(i.style.display="none")}else l.data.key=="UboChannelNameM3U8Changed"||(l.data.key=="UboReloadPlayer"?w():l.data.key=="UboPauseResumePlayer"?w(!1,!0):l.data.key=="UboSeekPlayer"&&w(!0))}),this.addEventListener("message",async l=>{if(l.data.key=="FetchRequest"){const i=l.data.value,u=await K(i);this.postMessage({key:"FetchResponse",value:u})}});function d(){var l=document.querySelector(".video-player"),i=null;return l!=null&&(i=l.querySelector(".ubo-overlay"),i==null&&(i=document.createElement("div"),i.className="ubo-overlay",i.innerHTML='<div class="player-ad-notice" style="color: white; background-color: rgba(0, 0, 0, 0.8); position: absolute; top: 0px; left: 0px; padding: 5px;"><p></p></div>',i.style.display="none",i.P=i.querySelector("p"),l.appendChild(i))),i}}},e=V(r,t);Object.defineProperty(unsafeWindow,"Worker",{get:function(){return e},set:function(a){$(a)?e=a:console.log("Attempt to set twitch worker denied")}})}function G(t){var r=new XMLHttpRequest;return r.open("GET",t,!1),r.overrideMimeType("text/javascript"),r.send(),r.responseText}function b(t,r,e){console.log("Found ads, switch to backup"),t.UseBackupStream=!0,t.IsMidroll=r.includes('"MIDROLL"')||r.includes('"midroll"'),e&&postMessage({key:"UboReloadPlayer"}),postMessage({key:"UboShowAdBanner",isMidroll:t.IsMidroll})}async function L(t,r,e){var a=StreamInfosByUrl[t];if(a==null)return console.log("Unknown stream url "+t),r;if(!OPT_MODE_STRIP_AD_SEGMENTS)return r;var n=r.includes(AD_SIGNIFIER);if(a.UseBackupStream){if(a.Encodings==null)return console.log("Found backup stream but not main stream?"),a.UseBackupStream=!1,postMessage({key:"UboReloadPlayer"}),"";var o=a.Encodings.match(/^https:.*\.m3u8$/m)[0],s=await e(o);if(s.status==200){var c=await s.text();if(c!=null){if(!c.includes(AD_SIGNIFIER))console.log("No more ads on main stream. Triggering player reload to go back to main stream..."),a.UseBackupStream=!1,postMessage({key:"UboHideAdBanner"}),postMessage({key:"UboReloadPlayer"});else if(!c.includes('"MIDROLL"')&&!c.includes('"midroll"'))for(var d=c.replace("\r","").split(`
`),l=0;l<d.length;l++){var i=d[l];if(i.startsWith("#EXTINF")&&d.length>l+1&&!i.includes(LIVE_SIGNIFIER)&&!a.RequestedAds.has(d[l+1])){a.RequestedAds.add(d[l+1]),fetch(d[l+1]).then(u=>{u.blob()});break}}}}}else n?b(a,r,!0):postMessage({key:"UboHideAdBanner"});if(n&&a.BackupEncodings!=null){var o=a.BackupEncodings.match(/^https:.*\.m3u8.*$/m)[0],s=await e(o);s.status==200&&(r=await s.text())}return r}function j(){console.log("hookWorkerFetch (video-swap-new)");var t=fetch;fetch=async function(r,e){if(typeof r=="string"){if(r=r.trimEnd(),r.endsWith("m3u8"))return new Promise(function(n,o){var s=async function(d){var l=await L(r,await d.text(),t);n(new Response(l,{status:d.status,statusText:d.statusText,headers:d.headers}))},c=function(){return t(r,e).then(function(d){s(d)}).catch(function(d){console.log("fetch hook err "+d),o(d)})};c()});if(r.includes("/api/channel/hls/")&&!r.includes("picture-by-picture")){var a=new URL(r).pathname.match(/([^\/]+)(?=\.\w+$)/)[0];if(CurrentChannelNameFromM3U8!=a&&postMessage({key:"UboChannelNameM3U8Changed",value:a}),CurrentChannelNameFromM3U8=a,OPT_MODE_STRIP_AD_SEGMENTS)return new Promise(async function(n,o){var s=StreamInfos[a];if(s!=null&&s.Encodings!=null&&(await t(s.Encodings.match(/^https:.*\.m3u8$/m)[0])).status!==200&&(s=null),s==null||s.Encodings==null||s.BackupEncodings==null){StreamInfos[a]=s={RequestedAds:new Set,Encodings:null,BackupEncodings:null,IsMidroll:!1,UseBackupStream:!1,ChannelName:a};for(var c=0;c<2;c++){var d=r;if(c==1){var l=await F(a,OPT_BACKUP_PLAYER_TYPE,OPT_BACKUP_PLATFORM);if(l!=null&&l.status===200){var i=await l.json(),u=new URL("https://usher.ttvnw.net/api/channel/hls/"+a+".m3u8"+new URL(r).search);u.searchParams.set("sig",i.data.streamPlaybackAccessToken.signature),u.searchParams.set("token",i.data.streamPlaybackAccessToken.value),d=u.href}else{n(l);return}}var v=await t(d,e);if(v!=null&&v.status===200){var g=await v.text();if(c==0){s.Encodings=g;var f=g.match(/^https:.*\.m3u8$/m)[0],p=await t(f);if(p.status==200){var h=await p.text();h.includes(AD_SIGNIFIER)&&b(s,h,!1)}else{n(p);return}}else{for(var m=g.replace("\r","").split(`
`),k=null,y=0;y<m.length;y++)if(m[y].startsWith("#EXT-X-STREAM-INF")){var C=E(m[y]).RESOLUTION;if(C&&m[y+1].endsWith(".m3u8")){k=m[y+1];break}}if(k!=null&&s.Encodings!=null){for(var Q=s.Encodings,S=Q.replace("\r","").split(`
`),y=0;y<S.length-1;y++)if(S[y].startsWith("#EXT-X-STREAM-INF")){var C=E(S[y]).RESOLUTION;C&&(k+=" ",S[y+1]=k)}g=S.join(`\r
`)}s.BackupEncodings=g}for(var A=g.replace("\r","").split(`
`),y=0;y<A.length;y++)!A[y].startsWith("#")&&A[y].includes(".m3u8")&&(StreamInfosByUrl[A[y].trimEnd()]=s)}else{n(v);return}}}s.UseBackupStream?n(new Response(s.BackupEncodings)):n(new Response(s.Encodings))})}}return t.apply(this,arguments)}}function _(t,r,e){return[{operationName:"ClientSideAdEventHandling_RecordAdEvent",variables:{input:{eventName:t,eventPayload:JSON.stringify(e),radToken:r}},extensions:{persistedQuery:{version:1,sha256Hash:"7e6c69e6eb59f8ccb97ab73686f3d8b7d85a72a0298745ccd8bfc68e4054ca5b"}}}]}function F(t,r,e){e||(e="web");var a=null,n='query PlaybackAccessToken_Template($login: String!, $isLive: Boolean!, $vodID: ID!, $isVod: Boolean!, $playerType: String!) {  streamPlaybackAccessToken(channelName: $login, params: {platform: "'+e+'", playerBackend: "mediaplayer", playerType: $playerType}) @include(if: $isLive) {    value    signature    __typename  }  videoPlaybackAccessToken(id: $vodID, params: {platform: "'+e+'", playerBackend: "mediaplayer", playerType: $playerType}) @include(if: $isVod) {    value    signature    __typename  }}';return a={operationName:"PlaybackAccessToken_Template",query:n,variables:{isLive:!0,login:t,isVod:!1,vodID:"",playerType:r}},T(a)}function T(t){if(!gql_device_id){const e="abcdefghijklmnopqrstuvwxyz0123456789";for(let a=0;a<32;a+=1)gql_device_id+=e.charAt(Math.floor(Math.random()*e.length))}var r={"Client-Id":CLIENT_ID,"Client-Integrity":ClientIntegrityHeader,"X-Device-Id":gql_device_id,Authorization:AuthorizationHeader};return new Promise((e,a)=>{const n=Math.random().toString(36).substring(2,15),o={id:n,url:"https://gql.twitch.tv/gql",options:{method:"POST",body:JSON.stringify(t),headers:r}};pendingFetchRequests.set(n,{resolve:e,reject:a}),postMessage({key:"FetchRequest",value:o})})}function E(t){return Object.fromEntries(t.split(/(?:^|,)((?:[^=]*)=(?:"[^"]*"|[^,]*))/).filter(Boolean).map(r=>{const e=r.indexOf("="),a=r.substring(0,e),n=r.substring(e+1),o=Number(n);return[a,Number.isNaN(o)?n.startsWith('"')?JSON.parse(n):n:o]}))}async function X(t){try{if(!t||!t.includes(AD_SIGNIFIER))return 1;var r=t.match(/#EXT-X-DATERANGE:(ID="stitched-ad-[^\n]+)\n/);if(r.length>1){const i=r[1],u=E(i);var e=parseInt(u["X-TV-TWITCH-AD-POD-LENGTH"]?u["X-TV-TWITCH-AD-POD-LENGTH"]:"1"),a=parseInt(u["X-TV-TWITCH-AD-POD-POSITION"]?u["X-TV-TWITCH-AD-POD-POSITION"]:"0"),n=u["X-TV-TWITCH-AD-RADS-TOKEN"],o=u["X-TV-TWITCH-AD-LINE-ITEM-ID"],s=u["X-TV-TWITCH-AD-ORDER-ID"],c=u["X-TV-TWITCH-AD-CREATIVE-ID"],d=u["X-TV-TWITCH-AD-ADVERTISER-ID"],l=u["X-TV-TWITCH-AD-ROLL-TYPE"].toLowerCase();const v={stitched:!0,roll_type:l,player_mute:!1,player_volume:.5,visible:!0};for(let g=0;g<e;g++)if(OPT_MODE_NOTIFY_ADS_WATCHED_MIN_REQUESTS)await T(_("video_ad_pod_complete",n,v));else{const f={...v,ad_id:d,ad_position:g,duration:30,creative_id:c,total_ads:e,order_id:s,line_item_id:o};await T(_("video_ad_impression",n,f));for(let p=0;p<4;p++)await T(_("video_ad_quartile_complete",n,{...f,quartile:p+1}));await T(_("video_ad_pod_complete",n,v))}}return 0}catch(i){return console.log(i),0}}function P(t,r){R.forEach(e=>{e.postMessage({key:t,value:r})})}function Y(t){return new Promise((r,e)=>{GM.xmlHttpRequest({method:t.options.method,url:t.url,data:t.options.body,headers:t.options.headers,onload:a=>r(a),onerror:a=>e(a)})})}function z(t){const r=new Headers;return t.trim().split(/[\r\n]+/).forEach(a=>{const n=a.split(":"),o=n.shift(),s=n.join(":");r.append(o,s)}),r}var O=!1,D=!1;async function K(t){try{if(O||!D){const e=await unsafeWindow.realFetch(t.url,t.options),a=await e.text(),n={id:t.id,status:e.status,statusText:e.statusText,headers:Object.fromEntries(e.headers.entries()),body:a};if(n.status===200){var r=JSON.parse(a);typeof r.errors<"u"?D=!0:O=!0}if(O||!D)return n}if(typeof GM<"u"&&typeof GM.xmlHttpRequest<"u"){t.options.headers["Sec-Ch-Ua"]='"Google Chrome";v="137", "Chromium";v="137", "Not/A)Brand";v="24"',t.options.headers.Referer="https://www.twitch.tv/",t.options.headers.Origin="https://www.twitch.tv/",t.options.headers.Host="gql.twitch.tv";const e=await Y(t),a=e.responseText;return{id:t.id,status:e.status,statusText:e.statusText,headers:Object.fromEntries(z(e.responseHeaders).entries()),body:a}}throw{message:"Failed to resolve GQL request. Try the userscript version of the ad blocking solution"}}catch(e){return{id:t.id,error:e.message}}}function J(){var t=unsafeWindow.fetch;unsafeWindow.realFetch=t,unsafeWindow.fetch=function(r,e,...a){if(typeof r=="string"&&r.includes("gql")){var n=e.headers["X-Device-Id"];if(typeof n!="string"&&(n=e.headers["Device-ID"]),typeof n=="string"&&(gql_device_id=n),gql_device_id&&P("UboUpdateDeviceId",gql_device_id),typeof e.body=="string"&&e.body.includes("PlaybackAccessToken")){if(OPT_ACCESS_TOKEN_PLAYER_TYPE){const o=JSON.parse(e.body);if(Array.isArray(o))for(let s=0;s<o.length;s++)o[s].variables.playerType=OPT_ACCESS_TOKEN_PLAYER_TYPE;else o.variables.playerType=OPT_ACCESS_TOKEN_PLAYER_TYPE;e.body=JSON.stringify(o)}typeof e.headers["Client-Integrity"]=="string"&&(ClientIntegrityHeader=e.headers["Client-Integrity"],ClientIntegrityHeader&&P("UpdateClientIntegrityHeader",e.headers["Client-Integrity"])),typeof e.headers.Authorization=="string"&&(AuthorizationHeader=e.headers.Authorization,AuthorizationHeader&&P("UpdateAuthorizationHeader",e.headers.Authorization))}}return t.apply(this,arguments)}}function w(t,r){function e(f,p){if(f.stateNode&&p(f.stateNode))return f.stateNode;let h=f.child;for(;h;){const m=e(h,p);if(m)return m;h=h.sibling}return null}function a(){var f=null,p=document.querySelector("#root");if(p&&p._reactRootContainer&&p._reactRootContainer._internalRoot&&p._reactRootContainer._internalRoot.current&&(f=p._reactRootContainer._internalRoot.current),f==null){var h=Object.keys(p).find(m=>m.startsWith("__reactContainer"));h!=null&&(f=p[h])}return f}var n=a();if(!n){console.log("Could not find react root");return}var o=e(n,f=>f.setPlayerActive&&f.props&&f.props.mediaPlayerInstance);o=o&&o.props&&o.props.mediaPlayerInstance?o.props.mediaPlayerInstance:null;var s=e(n,f=>f.setSrc&&f.setInitialPlaybackSettings);if(!o){console.log("Could not find player");return}if(!s){console.log("Could not find player state");return}if(o.paused||o.core?.paused)return;if(t){console.log("Force seek to reset player (hopefully fixing any audio desync) pos:"+o.getPosition()+" range:"+JSON.stringify(o.getBuffered()));var c=o.getPosition();o.seekTo(0),o.seekTo(c);return}if(r){o.pause(),o.play();return}const d="video-quality",l="video-muted",i="volume";var u=localStorage.getItem(d),v=localStorage.getItem(l),g=localStorage.getItem(i);o?.core?.state&&(localStorage.setItem(l,JSON.stringify({default:o.core.state.muted})),localStorage.setItem(i,o.core.state.volume)),o?.core?.state?.quality?.group&&localStorage.setItem(d,JSON.stringify({default:o.core.state.quality.group})),s.setSrc({isNewMediaPlayerInstance:!0,refreshAccessToken:!0}),setTimeout(()=>{localStorage.setItem(d,u),localStorage.setItem(l,v),localStorage.setItem(i,g)},3e3)}function M(){try{Object.defineProperty(document,"visibilityState",{get(){return"visible"}})}catch{}let t=document.__lookupGetter__("hidden"),r=document.__lookupGetter__("webkitHidden");try{Object.defineProperty(document,"hidden",{get(){return!1}})}catch{}var e=i=>{i.preventDefault(),i.stopPropagation(),i.stopImmediatePropagation()};let a=!0;var n=i=>{if(typeof chrome<"u"){const u=document.getElementsByTagName("video");u.length>0&&(t.apply(document)===!0||r&&r.apply(document)===!0?a=!u[0].paused&&!u[0].ended:a&&!u[0].ended&&u[0].play())}e(i)};document.addEventListener("visibilitychange",n,!0),document.addEventListener("webkitvisibilitychange",n,!0),document.addEventListener("mozvisibilitychange",n,!0),document.addEventListener("hasFocus",e,!0);try{/Firefox/.test(navigator.userAgent)?Object.defineProperty(document,"mozHidden",{get(){return!1}}):Object.defineProperty(document,"webkitHidden",{get(){return!1}})}catch{}for(var o=["video-quality","video-muted","volume","lowLatencyModeEnabled","persistenceEnabled"],s=new Map,c=0;c<o.length;c++)s.set(o[c],localStorage.getItem(o[c]));var d=localStorage.setItem;localStorage.setItem=function(i,u){s.has(i)&&s.set(i,u),d.apply(this,arguments)};var l=localStorage.getItem;localStorage.getItem=function(i){return s.has(i)?s.get(i):l.apply(this,arguments)}}unsafeWindow.reloadTwitchPlayer=w,N(unsafeWindow),x(),J(),document.readyState==="complete"||document.readyState==="loaded"||document.readyState==="interactive"?M():unsafeWindow.addEventListener("DOMContentLoaded",function(){M()})})();
