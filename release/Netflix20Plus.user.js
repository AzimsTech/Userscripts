// ==UserScript==
// @name                 Netflix Plus
// @namespace            http://tampermonkey.net/
// @version              4.2
// @author               TGSAN
// @match                https://www.netflix.com/*
// @icon                 https://www.google.com/s2/favicons?sz=64&domain=netflix.com
// @run-at               document-start
// @sandbox              raw
// @grant                unsafeWindow
// @grant                GM_setValue
// @grant                GM_getValue
// @grant                GM_registerMenuCommand
// @grant                GM_unregisterMenuCommand
// @downloadURL https://raw.githubusercontent.com/AzimsTech/Userscripts/release/release/Netflix20Plus.user.js
// @updateURL https://raw.githubusercontent.com/AzimsTech/Userscripts/release/release/Netflix20Plus.meta.js
// ==/UserScript==
(async()=>{"use strict";let t=self.window;self.unsafeWindow?(console.log("[Netflix Plus] use unsafeWindow mode"),t=self.unsafeWindow):console.log("[Netflix Plus] use window mode (your userscript extensions not support unsafeWindow)"),t.addEventListener("load",function(){const e=t.document.createElement("div");t.document.body.appendChild(e),e.style.width="100%",e.style.height="100%",e.style.backgroundColor="transparent",e.style.zIndex=9999,e.style.pointerEvents="none",e.style.position="fixed",e.style.backdropFilter="blur(0px)"});{const e=document.createElement("meta");e.httpEquiv="Cache-Control",e.content="no-cache",t.document.head.appendChild(e)}{const e=document.createElement("meta");e.httpEquiv="Pragma",e.content="no-cache",t.document.head.appendChild(e)}{const e=document.createElement("meta");e.httpEquiv="Expires",e.content="-1",t.document.head.appendChild(e)}function E(){let e=document.createElement("div");return e.style.position="fixed",e.style.top="20px",e.style.left="50%",e.style.transform="translateX(-50%)",e.style.padding="10px 20px",e.style.backgroundColor="rgba(250, 250, 250, 1.0)",e.style.color="rgba(32, 32, 32, 1.0)",e.style.fontSize="12px",e.style.textAlign="center",e.style.fontWeight="600",e.style.zIndex="9999",e.style.boxShadow="0 0 10px rgba(0, 0, 0, 0.25)",e.style.borderRadius="30px",e.style.opacity="0.0",e.style.transition="opacity 0.5s",document.body.appendChild(e),e}function O(e,n=1500){let s=E();s.innerText=e,setTimeout(function(){s.style.opacity="1.0",setTimeout(function(){s.style.opacity="0.0",setTimeout(function(){document.body.removeChild(s)},500)},n)},1)}let u,y=!0;t.Function.prototype.callNetflixPlusOriginal=t.Function.prototype.call,t.Function.prototype.call=function(...e){if(y){let n=this.toString();if(n.length>1e6&&n.indexOf("h264mpl")>-1&&n.indexOf("videoElementNetflixPlus")<0){console.log("PlayerCore found len: "+n.length),m();return}}return this.callNetflixPlusOriginal(...e)},t.netflix!==void 0&&t.netflix.player!==void 0&&(O(`Netflix Plus is executing too late and is being forced to run, which may cause issues.

Refresh the page while holding down the "Shift" key to resolve the issue.`,1e4),console.warn("The user script is executing too late and is being forced to run, which may cause issues."),m());function m(){const e=()=>{try{t.netflix.reactContext.models.playerModel.data.config.core.initParams.browserInfo.os.name=="linux"&&(t.netflix.reactContext.models.playerModel.data.config.core.initParams.browserInfo.os={name:"windows",version:"10.0"}),t.netflix.reactContext.models.playerModel.data.config.core.initParams.browserInfo.hardware!="computer"&&(t.netflix.reactContext.models.playerModel.data.config.core.initParams.browserInfo.hardware="computer")}catch{setTimeout(e,0)}};if(e(),y=!1,u==null){for(let s of t.document.getElementsByTagName("script"))if(s.src&&s.src.indexOf("cadmium-playercore")>-1){u=s;break}}let n=document.createElement("script");n.src="https://www.cloudmoe.com/static/userscript/netflix-plus/cadmium-playercore.js",n.async=u.async,n.id=u.id,u.replaceWith(n)}t._videoElementNetflixPlus,Object.defineProperty(t,"videoElementNetflixPlus",{get:function(){return t._videoElementNetflixPlus},set:function(e){let n=t._videoElementNetflixPlus;t._videoElementNetflixPlus=e,e.addEventListener("playing",function(){if(n===e||!t.globalOptions.setMaxBitrateOld)return;let s=function(a){return document.evaluate(a,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue},r=function(){t.dispatchEvent(new KeyboardEvent("keydown",{keyCode:83,ctrlKey:!0,altKey:!0,shiftKey:!0})),t.dispatchEvent(new KeyboardEvent("keydown",{keyCode:66,ctrlKey:!0,altKey:!0,shiftKey:!0}));const a=s("//div[text()='Video Bitrate / VMAF']"),c=s("//div[text()='Audio Bitrate']"),i=s("//button[text()='Override']");a&&c&&i?([a,c].forEach(function(l){let o=l.parentElement;o.querySelectorAll("select").forEach(function(D){D.removeAttribute("disabled")});let p=o.querySelectorAll("select > option");for(var h=0;h<p.length-1;h++)p[h].removeAttribute("selected");p[p.length-1].setAttribute("selected","selected")}),setTimeout(function(){i.click()},100),n=e):setTimeout(r,100)};r()})}}),t.modifyStreamInfoFilterNetflixPlus=function(e){if(t.globalOptions.onlyMaxBitrate){console.debug("[OnlyMaxBitrate] Dump Data",e);for(const n in e){const s=e[n],r=s.audio_tracks,a=s.video_tracks;if(r&&a){const c=s;console.debug(`[OnlyMaxBitrate] Found StreamInfo in ${n}`);for(const i in c){const l=c[i];if(Array.isArray(l)&&l.length>0&&l[0].streams){console.debug(`[OnlyMaxBitrate] Found CurrentSelectedStreamInfo in ${i}`);for(let o=0;l.length>o;o++)l[o].streams=[l[o].streams.pop()],l[o].bitrates&&(l[o].bitrates=[l[o].bitrates.pop()])}}}}}return e},t.modifyFilterNetflixPlus=function(e,n,s){let r=s==="playready"?30:0;return t.globalOptions.useprk&&(e.push("h264mpl30-dash-playready-prk-qc"),e.push("h264mpl31-dash-playready-prk-qc"),e.push("h264mpl40-dash-playready-prk-qc")),r==30?(t.globalOptions.useddplus&&(e.push("ddplus-2.0-dash"),e.push("ddplus-5.1-dash"),e.push("ddplus-5.1hq-dash"),e.push("ddplus-atmos-dash")),t.globalOptions.usehevc&&(e=e.filter(a=>{if(!new RegExp(/main10-L5/g).test(JSON.stringify(a)))return a})),t.globalOptions.usef12k&&(e=e.filter(a=>{if(!new RegExp(/hevc-main10-L.*-dash-cenc-prk-do/g).test(JSON.stringify(a)))return a})),t.globalOptions.usef4k&&(e.push("hevc-main10-L30-dash-cenc"),e.push("hevc-main10-L31-dash-cenc"),e.push("hevc-main10-L40-dash-cenc"),e.push("hevc-main10-L41-dash-cenc"))):(t.globalOptions.useFHD&&(e.push("playready-h264mpl40-dash"),e.push("playready-h264hpl40-dash"),e.push("vp9-profile0-L40-dash-cenc"),e.push("av1-main-L50-dash-cbcs-prk"),e.push("av1-main-L51-dash-cbcs-prk"),e.push("av1-hdr10plus-main-L40-dash-cbcs-prk"),e.push("av1-hdr10plus-main-L41-dash-cbcs-prk"),e.push("av1-hdr10plus-main-L50-dash-cbcs-prk"),e.push("av1-hdr10plus-main-L51-dash-cbcs-prk")),t.globalOptions.useHA&&e.push("heaac-5.1-dash"),t.globalOptions.usedef||(t.globalOptions.useav1&&(e.push("av1-main-L20-dash-cbcs-prk"),e.push("av1-main-L21-dash-cbcs-prk"),e=e.filter(a=>{if(!new RegExp(/h264/g).test(JSON.stringify(a)))return a}),e=e.filter(a=>{if(!new RegExp(/vp9-profile/g).test(JSON.stringify(a)))return a})),t.globalOptions.usevp9&&(e.push("vp9-profile0-L21-dash-cenc"),e=e.filter(a=>{if(!new RegExp(/h264/g).test(JSON.stringify(a)))return a}),e=e.filter(a=>{if(!new RegExp(/av1-main/g).test(JSON.stringify(a)))return a})),t.globalOptions.useAVCH&&(e=e.filter(a=>{if(!new RegExp(/vp9-profile/g).test(JSON.stringify(a)))return a}),e=e.filter(a=>{if(!new RegExp(/av1-main/g).test(JSON.stringify(a)))return a})),t.globalOptions.useAVC&&(e=e.filter(a=>{if(!new RegExp(/vp9-profile/g).test(JSON.stringify(a)))return a}),e=e.filter(a=>{if(!new RegExp(/h264hp/g).test(JSON.stringify(a)))return a}),e=e.filter(a=>{if(!new RegExp(/av1-main/g).test(JSON.stringify(a)))return a})))),t.globalOptions.useallSub&&(n.showAllSubDubTracks=1),t.globalOptions.closeimsc&&(e=e.filter(a=>{if(!new RegExp(/imsc1.1/g).test(JSON.stringify(a)))return a})),[e,n,s]};const S=t.fetch;t.fetch=(...e)=>{let n="",s=!1;switch(typeof e[0]){case"object":n=e[0].url,s=!0;break;case"string":n=e[0];break;default:break}if(n.indexOf("//web.prod.cloud.netflix.com/graphql")>-1&&typeof e[1]=="object"){let r=e[1];if(typeof r.body=="string"&&r.body.startsWith("{")&&r.body.endsWith("}")){let a=JSON.parse(r.body);if(typeof a.operationName=="string"&&t.globalOptions.disableHouseholdCheck&&a.operationName.startsWith("CLCSInterstitial"))return console.debug("[DisableHouseholdCheck] Mocked: "+a.operationName),new Promise(c=>{let i={data:{}};i.data["body.operationName"]=null,c(new Response(JSON.stringify(i)))});r.body=JSON.stringify(a)}e[1]=r}return S(...e)};const k=class{constructor(e,n){this.script=e,this.target=n,this._cancel=!1,this._replace=null,this._stop=!1}preventDefault(){this._cancel=!0}stopPropagation(){this._stop=!0}replacePayload(e){this._replace=e}};let f=[];t.addBeforeScriptExecuteListener=e=>{if(typeof e!="function")throw new Error("Event handler must be a function.");f.push(e)},t.removeBeforeScriptExecuteListener=e=>{let n=f.length;for(;n--;)f[n]===e&&f.splice(n,1)};const P=(e,n)=>{if(e.tagName!=="SCRIPT")return;const s=new k(e,n);if(typeof t.onbeforescriptexecute=="function")try{t.onbeforescriptexecute(s)}catch(r){console.error(r)}for(const r of f){if(s._stop)break;try{r(s)}catch(a){console.error(a)}}s._cancel?(e.textContent="",e.remove()):typeof s._replace=="string"&&(e.textContent=s._replace)};new MutationObserver(e=>{for(const n of e)for(const s of n.addedNodes)P(s,n.target)}).observe(document,{childList:!0,subtree:!0});const g=[["onlyMaxBitrate","Only use best bitrate available"],["useallSub","Show all audio-tracks and subs"],["closeimsc","Use SUP subtitle replace IMSC subtitle"],["useDDPandHA","Enable Dolby and HE-AAC 5.1 Audio"],["alwaysUseHDR","Always use HDR or Dolby Vision when available"],["disableHouseholdCheck","Disable checks for Netflix Household"]];let d=[];t.globalOptions={disableHouseholdCheck:!0,useDDPandHA:!0,useXHA:!1,alwaysUseHDR:!1,onlyMaxBitrate:!0,get onlyVideoMaxBitrate(){return t.globalOptions.onlyMaxBitrate},get onlyAudioMaxBitrate(){return t.globalOptions.onlyMaxBitrate},setMaxBitrateOld:!1,useallSub:!0,get useddplus(){return t.globalOptions.useDDPandHA},useAVC:!1,usedef:!1,get useHA(){return t.globalOptions.useDDPandHA},useAVCH:!0,usevp9:!1,useav1:!1,useprk:!0,usehevc:!1,usef4k:!0,usef12k:!1,closeimsc:!0,useFHD:!0,forceUHD:!1},await b()?g.push(["forceUHD","Force use UHD when available"]):x("forceUHD",!1),t.onbeforescriptexecute=function(e){let n=document.getElementsByTagName("script");if(n.length!==0)for(let s=0;n.length>s;s++){let r=n[s];if(r.src.includes("cadmium-playercore")){u=r,console.warn("parsing playercore dom"),t.onbeforescriptexecute=null;break}}};async function A(){let e=!1;return t.MSMediaKeys&&(e=!0),t.WebKitMediaKeys&&(e=!0),await b()&&(e=!0),console.debug("Supported advanced DRM: "+e),e}async function b(){let e=[{videoCapabilities:[{contentType:"video/mp4;codecs=avc1.42E01E",robustness:"HW_SECURE_ALL"}]}];try{return await navigator.requestMediaKeySystemAccess("com.widevine.alpha.experiment",e),!0}catch{return!1}}async function x(e,n){await GM_setValue("NETFLIX_PLUS_"+e,n)}async function v(e){let n=await GM_getValue("NETFLIX_PLUS_"+e);return typeof n=="boolean"?n:t.globalOptions[e]}async function C(e,n){let s=await v(n);return t.globalOptions[n]=s,await GM_registerMenuCommand((await v(n)?"\u2705":"\u{1F532}")+" "+e,async function(){await x(n,!s),t.globalOptions[n]=!s,w()})}async function w(){for(let e of d)await GM_unregisterMenuCommand(e);d=[];for(let e of g)d.push(await C(e[1],e[0]))}async function N(){t.globalOptions.forceUHD&&(delete t.screen,t.__defineGetter__("screen",function(){let e=[];return e.width=7680,e.height=4320,e.availWidth=7680,e.availHeight=4320,e.availLeft=0,e.availTop=0,e.colorDepth=32,e.isExtended=!1,e.pixelDepth=32,e}),delete t.devicePixelRatio,t.devicePixelRatio=4,t.MediaKeys.prototype.getStatusForPolicyOriginal=t.MediaKeys.prototype.getStatusForPolicy,t.MediaKeys.prototype.getStatusForPolicy=async function(e){return"usable"})}await w(),await N()})();
